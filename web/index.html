<!DOCTYPE html>
<html>
<head>
 <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=2.0, minimum-scale=1.0, user-scalable=0">
 <meta name="mobile-web-app-capable" content="yes">
 <meta name="apple-mobile-web-app-capable" content="yes">
	<title>Canvas</title>
    <script src="./scripts/framework/jquery-3.1.1.js"></script>
	<style type="text/css">
		* {
			margin: 0px;
			padding:0px;
		}
		body,html {
			overflow:hidden;
			height: 100%;
			width: 100%;
			font-family:sans-serif;
		}
		body {
			position: fixed;
		}
		canvas {
			display:inline;
		}

		.Emergency_btn {
			width:50px;
			height: 50px;
			border-radius:25px;
			background:#F44336;
			margin:20px;
			text-align: center;
			color: white;
			font-weight: bold;
			font-size: small;
			cursor: pointer;
			position: relative;
		}

		.Emergency_btn span {
		    width: 100%;
		    height: 20px;
		    line-height: 20px;
		    margin-top: 15px;
		    margin-bottom: 15px;
		    float: left;
		    display: block;
		}

		.Emergency_btn .Emergency_Em_img, .Emergency_btn .Emergency_Es_img {
			display: none;
		}

		.Emergency_btn.Emergency_Em span, .Emergency_btn.Emergency_Es span {
			display: none;
		}

		.Emergency_btn.Emergency_Em .Emergency_Em_img {
			display: block;
			position: absolute;
			top:12px;
			width:24px;
			left: 12px;
		}

		.Emergency_btn.Emergency_Es .Emergency_Es_img {
			display: block;
			position: absolute;
			top:12px;
			width:24px;
			left: 12px;
		}

		.menu_toggle_btn img {
			position: absolute;
			top:5px;
			width:16px;
			left: 17px;
			transition: 0.75s;
		}

		.menu_toggle_btn {
			position: absolute;
			margin: 0px;
			margin-left: 20px;
			bottom:-45px;
		}

		.menu_toggle_btn img.active {
			transform: scaleY(-1);
		}

		.menu {
			position: absolute;
			transition: 0.75s;
			left:0px;
		}

		.menu.active {
			bottom:0px;
		}

		.menu_btn {
			cursor: pointer;
			background:#2196F3;
			left:0px;
			width:50px;
			height: 50px;
			border-radius:25px;
			margin:20px;
		}

		.menu_btn:hover{
			background: #1565C0;
		}

		#train_list {
			position: absolute;
			bottom:0px;
			background: #eee;
			padding-left: 90px;
			padding-right: 20px;
			width: calc(100% - 110px);
			overflow-x:hidden;
			height: 90px;
			overflow-x: hidden;
			overflow-y: hidden;
		}

		#train_list .scroller {
			margin-left: -20px;
			height: 150%;
			min-width: 100%;
			max-height: 150%;
			overflow-x:scroll;
			overflow-wrap: nowrap;
			overflow-y:hidden;
		}

		#train_list .list {
			margin:20px;
			height: calc(100% - 40px);
			width: calc(25% - 40px);
			float:left;
			background: grey;
			overflow-x: hidden;
			overflow-y: hidden;
		}

		#train_list .train_list_box {
			width:200px;
			height:40px;
			padding:5px;
			border-radius:5px;
			background:lightgrey;
			border: 1px solid lightgrey;
			position:relative;
			margin:20px;
			float:left;
			cursor: pointer;
		}

		#train_list .train_list_box.active {
			background:grey;
			border: 1px solid grey;
		}

		#train_list .train_list_box .img {
			width:70px;
			height:50px;
			top:0px;
			left:0px;
			position: absolute;
			border-top-left-radius: 5px;
			border-bottom-left-radius: 5px;
			overflow: hidden;
    		background-size: cover;
    		background-position: center; 
		}

		#train_list .train_list_box .name {
			left: 70px;
			top: 7px;
			width: calc(100% - 70px);
			position: absolute;
			text-align: center;
			font-weight: bold;
			font-size:small;
		}

		#train_list .train_list_box .id {
			left: 70px;
			bottom: 7px;
			width: calc(100% - 70px);
			position: absolute;
			text-align: center;
			font-size:small;
		}

		#route {
			display: flex;
			justify-content: center;
			height: calc(100% - 90px);
		}

		#route.vertical{ overflow-y: auto; flex-wrap: wrap;}
		#route.horizontal{overflow-x: auto;flex-wrap: nowrap;}

		#route .station_Box {
			padding:10px 20px;
			border:1px solid lightgrey;
			background: lightgrey;
			border-radius:2px;
			width:200px;
			overflow:hidden;
			float:left;
			margin:10px;
			align-self: flex-start;
			flex: 0 0 auto;
		}

		#route .station_Box .header {
			font-weight:bold;
			text-align:center;
			width:100%;
		}

		#route .station_Box .scroller {
			width:150%;
			height: 292px;
			overflow-y: auto;
		}

		#route .station_Box .station {
			position: relative;
			float:left;
			width:192px;
			height:50px;
			background:#e6e6e6;
			border-radius: 2px;
			margin:4px;
		}

		#route .station_Box .station.active {
			background: #ccc;
		}

		#route .station_Box .station_type {
			position:absolute;
			left:0px;
			width:100%;
			height:3px;
			display: inline;
			border-top-left-radius: 2px;
			border-top-right-radius: 2px;
		}

		#route .station_Box .station_type.person {
			background:lightblue
		}

		#route .station_Box .station_type.cargo {
			background:lightcoral;
		}

		#route .station_Box .station_type.storage {
			background:lightsalmon;
		}

		#route .station_Box .station_name {
			position:absolute;left:0px;top:3px;width: 100%;text-align: center;
		}

		#route .station_Box .station_DCC_id {
			position:absolute;left:5px;bottom:4px;width: 50px;text-align: left;
		}

		#route .station_Box .station_state {
			position:absolute;right:5px;bottom:4px;width: 145px;text-align: right;
		}

		#route .station_Box .lengthL {
			border-bottom-left-radius: 2px;
			left: 0px;
		}

		#route .station_Box .lengthR {
			border-bottom-right-radius: 2px;
			right: 0px;
		}

		#route .station_Box .length_1 {
			width: 100%;
		}

		#route .station_Box .length_2.m {
			width: 60px;
			left: calc(50% - 30px);
		}

		#route .station_Box .length_2 {
			width: calc(50% - 32px);
		}

		#route .station_Box .length_1, #route .station_Box .length_2 {
			position:absolute;
			bottom:0px;
			height:3px;
			background: green;
			line-height: 1px;
			color: transparent;
			text-align: center;
			float:left;
		}

		#route .station_Box .length_1.active, #route .station_Box .length_2.active {
			height:20px;
			color:white;
			line-height:20px;
		}

		#route .station_Box .set {
			background: red;
		}

		#route .station_Box .expected {
			background: orange;
		}

		#route .station_Box .leaving {
			background: darkorange;
		}

		#trains {
			float:left;
			width:100%;
		}

		#trains.half {
			width: 50%;
		}

		#trains .controlA, #trains .controlB {
			margin:20px;
			height: calc(100% - 52px);
			width: calc(50% - 52px);
			float:left;
			background:lightgrey;
			padding: 5px;
			border: 1px solid lightgrey;
			border-radius: 5px;
			position: relative;
		}
		#trains.half .controlA {
			width: calc(100% - 52px);
		}
		#trains.half .controlB {
			display: none;
		}

		#trains .control .name {
			font-size:large;
		}

		#trains .specs {
			width:calc(100% - 78px);
			height:calc(100% - 10px);
			position: relative;
		}

		@media only screen and (max-width: 600px) {
		    #trains .controlA {
				width: calc(100% - 50px);
			}

			 #trains .controlB {
			 	display:none;
			 }
		}

		#trains .funcs, #train_hover .funcs {
			display: flex;
			width: 100%;
			overflow-x: hidden;
			flex-wrap: wrap;
			justify-content: center;
			align-items: flex-end;
			margin-top:5px;
		}

		#trains .func, #train_hover .func {
			width: 25px;
			height: 20px;
			line-height: 20px;
			text-align: center;
			background: grey;
			margin: 2px;
			border-radius: 2px;
			color: white;
			font-size: smaller;
			font-weight: bold;
		}

		#train_hover {
			position: fixed;
			width:260px;
			padding: 5px;
			height:360px;
			border: 1px solid grey;
			border-radius: 5px;
			box-shadow: 0px 0px 20px 2px grey;
			background: lightgrey;
			z-index: 1;
		}

		.slider_containter {
			position: absolute;
			right:25px;
			bottom:25px;
			height: calc(100% - 50px);
			width:30px;
			box-shadow: 0px 1px 6px 2px #bbb;
			background: white;
			border-radius: 15px;
			overflow: hidden;
		}

		.slider {
			bottom: 0px;
			height: 75%;
			width:100%;
			background: #ff9800;
			position: absolute;
		}

		.slider_value {
			top: 5px;
			width: 100%;
			color: white;
			position: absolute;
			font-weight: bold;
			font-size: smaller;
			text-align: center;
		}

		.slider_value.inverse {
			top: -18px;
			color: black;
		}

		#train_hover .specs {
			width:calc(100% - 78px);
			height:calc(100% - 10px);
			position: relative;
		}

		#train_hover .specs .img, #trains .specs .img {
			width:calc(100% - 10px);
			margin:5px;
			padding-top:50%;
			background-size: cover;
			background-position: center;
		}

		#train_hover .specs .row, #trains .specs .row {
			width: calc(100% - 40px);
			background: #aaa;
			color: white;
			margin: 0px 5px;
			padding: 3px 15px;
			text-align: center;
			min-height:18px;
		}

		#train_hover .specs .name, #trains .specs .name {
			background: grey;
			color: white;
			font-weight: bold;
			margin-top: -5px;
			border-top: 2px solid white;
		}

		#train_hover .specs .type, #trains .specs .type {
			float:left;
		}

		#train_hover .specs .route, #trains .specs .route {
			float: right;
		}

		#settings {
			width:100%;
			height: calc(100% - 90px);
			overflow: hidden;
			overflow-y: auto;
		}

		.settings_box {
			overflow: hidden;
			min-height: 100%;
		}

		.set-box {
		    width: calc(100% - 40px);
		    padding: 10px;
		    margin: 10px;
		    border: 2px solid #1565C0;
		    border-radius: 10px;
		    overflow: hidden;
		}

		.set-box > .header {
			width: calc(100% + 20px);
			padding: 10px 0px;
			padding-top: 10px;
			margin-top: -10px;
			margin-left: -10px;
			background: #1565C0;
			text-align: center;
			font-weight: bold;
			margin-bottom: 10px;
			color: white;
		}

		.box-containter {
			display: flex;
			flex-wrap: wrap;
		}

		.set-box .checkbox input[type="checkbox"] {
			display: inline-block;
		}

		.set-box .box,
		.set-box .checkbox,
		.set-box .buttonbox,
		.set-box .collapsebox {
			margin: 10px;
			border-radius: 5px;
			background: lightgrey;
			min-width: calc(50% - 30px);
			position: relative;
			overflow:hidden;
		}

		.set-box .checkbox {
			height: 30px;
			vertical-align: middle;
			padding-left: 10px;
			line-height: 30px;
			cursor: pointer;
		}

		.set-box .checkbox div {
			line-height: 30px;
			position: absolute;
			right: 0px;
			top: 0px;
			height: 30px;
			width: 100%;
			text-align: center;
		}

		.set-box .buttonbox, .set-box .collapsebox {
			height: 30px;
			vertical-align: middle;
			line-height: 30px;
			cursor: pointer;
			background: lightgrey;
			font-weight: bold;
			text-align: center;
		}

		.set-box .collapsebox.active{
			height: unset;
		}

		.set-box .collapsebox div {
			display: none;
		}

		.set-box .collapsebox.active div {
			display: block;
			border-top: 1px solid grey;
		}

		.set-box .collapsebox.active div:first-child {
			margin-top:5px;
		}

		@media only screen and (max-width: 600px){
			.set-box .checkbox,
			.set-box .buttonbox,
			.set-box .collapsebox {
				min-width: calc(100% - 30px);
			}
		}

		.set-box .box textarea {
			width: calc(100% - 12px);
			margin: 5px;
			height: 200px;
			white-space: nowrap;
			overflow: auto;
			resize: none;
			margin-bottom: 1px;
		}

		#log_box {
			height: 200px;
			margin: 5px;
			position: relative;
			width: calc(100% - 10px);
			font-family: monospace;
			overflow-y: auto;
			overflow-x: auto;
			white-space: nowrap;
			background: white;
		}
		
		.box.status-box-container {
			background: white;
			display: flex;
			flex-wrap: wrap;
			flex-direction: column;
			max-height:180px;
		}

		.status-box {
			float: left;
			width: calc(25% - 20px);
			margin: 5px;
			background: lightgrey;
			border-radius: 2px;
			text-align: center;
			padding: 5px;
			position: relative;
			overflow: hidden;
		}

		@media only screen and (max-width: 800px){
			.status-box {
				min-width: calc(50% - 20px);
			}
			.box.status-box-container {
				max-height: 340px;
			}
		}

		@media only screen and (min-width: 1000px){
			.status-box {
				min-width: calc(50% - 20px);
			}
			.box.status-box-container {
				max-height: 340px;
			}
		}

		@media only screen and (min-width: 1600px){
			.status-box {
				min-width: calc(25% - 20px);
			}
			.box.status-box-container {
				max-height: 180px;
			}
		}

		.status-box:before {
		    content: "";
		    position: absolute;
		    left: 0px;
		    top: 0px;
		    height: 100%;
		    width: 20px;
		}

		.status-box.green:before{
		    background: #66BB6A;
		}
		.status-box.red:before{
			background: #EF5350;
		}







		#train_compositor {
		    width: calc(100% - 80px);
		    max-height: calc(100% - 80px);
		    max-width: 1200px;
		    padding: 10px;
		    margin: 30px;
		    border: 2px solid #1565C0;
		    border-radius: 10px;
		    overflow: hidden;
		    background: white;
		    position: fixed;
		    top: 0px;
		    left: 50%;
		    box-shadow: 0px 0px 10px 5px lightgrey;
		    -webkit-transform: translate(calc(-50% - 30px), 0);
		    transform: translate(calc(-50% - 30px),0);
		    min-height: 200px;
		}

		#train_compositor .header {
			width: calc(100% + 20px);
			padding: 10px 0px;
			padding-top: 10px;
			margin-top: -10px;
			margin-left: -10px;
			background: #1565C0;
			text-align: center;
			font-weight: bold;
			margin-bottom: 10px;
			color: white;
		}

		#train_compositor .compositor {
			width: calc(100% - 2px);
			height: 106px;
			overflow: hidden;
			border: 1px solid grey;
		}

		#train_compositor .compositor .scroller {
			height: 150%;
			overflow-x: scroll;
		}

		#train_compositor .compositor .scroller > div{
			height: 106px;
		}

		#train_compositor .compositor .box{
			height: calc(100% - 6px);
			float: left;
			margin: 2px;
			border: 1px solid lightgrey;
		}

		#train_compositor .compositor .box img{
			height: 56px;
			margin: 2px;
			cursor: move;
		}

		#train_compositor .compositor .box .name{
			height: 14px;
			padding: 2px;
			line-height: 14px;
			width: calc(100% - 4px);
			background: lightgrey;
			text-align: center;
			font-size: smaller;
			font-weight: bold;
		}

		#train_compositor .compositor .box .control{
			height: 14px;
			padding: 2px;
			line-height: 14px;
			width: calc(100% - 4px);
			background: lightgreen;
			font-size: smaller;
			text-align: center;
			display: flex;
			justify-content: center;
		}

		#train_compositor .compositor .box .cbtn{
			height: 16px;
			width: 16px;
			margin: 0px 2px;
			background: grey;
			color: white;
			border-top-left-radius: 2px;
			border-top-right-radius: 2px;
		}

		#train_compositor .btn {
			width: 200px;
			margin: 5px;
			padding: 5px;
			float:left;
			background: lightgrey;
			text-align: center;
			border-radius: 2px;
		}

		#train_compositor .btn_container {
			width:440px;
			margin:20px auto;
			height:38px;
		}

		@media only screen and (max-width: 500px){
			#train_compositor .btn {
				width: calc(50% - 20px);
			}

			#train_compositor .btn_container {
				width: 100%;
			}
		}

		#train_compositor .selector {
			width: 100%;
			overflow-y: auto;
			display: flex;
			align-items: center;
			justify-content: center;
			flex-wrap: wrap;
		}

		#train_compositor .list_box {
			width:200px;
			height:40px;
			padding:5px;
			border-radius:5px;
			background:lightgrey;
			border: 1px solid lightgrey;
			position:relative;
			margin:10px 5px;
			float:left;
			cursor: pointer;
		}

		#train_compositor .list_box .img {
			width:70px;
			height:50px;
			top:0px;
			left:0px;
			position: absolute;
			border-top-left-radius: 5px;
			border-bottom-left-radius: 5px;
			overflow: hidden;
    		background-size: contain;
    		background-repeat: no-repeat;
    		background-position: center; 
		}

		#train_compositor .list_box .name {
			left: 70px;
			top: 7px;
			width: calc(100% - 70px);
			position: absolute;
			text-align: center;
			font-weight: bold;
			font-size:small;
		}

		#train_compositor .list_box .id {
			left: 70px;
			bottom: 7px;
			width: calc(100% - 70px);
			position: absolute;
			text-align: center;
			font-size:small;
		}





		#train_linker {
		    width: calc(100% - 80px);
		    max-height: calc(100% - 80px);
		    max-width: 600px;
		    padding: 10px;
		    margin: 30px;
		    border: 2px solid #1565C0;
		    border-radius: 10px;
		    background: white;
		    position: fixed;
		    top: 0px;
		    left: 50%;
		    box-shadow: 0px 0px 10px 5px lightgrey;
		    -webkit-transform: translate(calc(-50% - 30px), 0);
		    transform: translate(calc(-50% - 30px),0);
		    min-height: 200px;
		}

		#train_linker .header {
			width: calc(100% + 20px);
			padding: 10px 0px;
			padding-top: 10px;
			margin-top: -10px;
			margin-left: -10px;
			background: #1565C0;
			text-align: center;
			font-weight: bold;
			margin-bottom: 10px;
			color: white;
		}

		#train_linker .selected {
			width: calc(100% - 20px);
			border: 1px solid grey;
			margin: 20px auto;
			position: relative;
			height: 60px;
		}

		#train_linker .selected .container {
			width: 100%;
			height: 60px;
			cursor: pointer;
		}

		#train_linker .selected .selector{
			width: calc(100% - 2px);
			border: 2px solid grey;
			position: absolute;
			top: 100%;
			left: -1px;
			max-height: 290px;
			background: white;
			display: none;
			overflow: overlay;
		}

		#train_linker .selected .selector.active{
			display: block;
		}

		#train_linker .selector > div {
			width: 100%;
			height: 60px;
			position: relative;
			overflow: hidden;
			cursor: pointer;
		}

		#train_linker .selector > div:not(:last-child) {
			border-bottom: 1px solid grey;
		}

		#train_linker .selector > div:hover {
			background: #ddd;
		}

		#train_linker .selector .imgbox, #train_linker .selected .container .imgbox {
			width: calc(100% - 12px);
			height: 30px;
			border:1px solid lightgrey;
			top:5px;
			left:5px;
			position: absolute;
			overflow: hidden;
		}

		#train_linker .selector .imgbox .scroller, #train_linker .selected .container .imgbox .scroller {
			height: 60px;
			width: 100%;
			overflow-x: scroll;
			overflow-y: hidden;
		}

		#train_linker .selector .imgbox img, #train_linker .selected .container .imgbox img{
			height: 30px;
		}

		#train_linker .selector .textbox, #train_linker .selected .container .textbox {
			position: absolute;
			bottom: 0.25em;
			left: 0.5em;
			height: 1em;
			font-weight: bold;
			width: calc(100% - 0.5em);
		}

		#train_linker .name {
			position: absolute;
			left: 0px;
		}

		#train_linker .dcc {
			position: absolute;
			right: 20%;
			bottom: 0px;
			white-space: nowrap;
			font-size: x-small;
			vertical-align: text-bottom;
		}

		#train_linker .btn {
			width: calc(33% - 20px);
			margin: 5px;
			padding: 5px;
			float:left;
			background: lightgrey;
			text-align: center;
			border-radius: 2px;
            cursor: pointer;
		}

		#train_linker .btn_container {
			width: calc(100% - 40px);
			max-width:550px;
			margin:20px auto;
			height:38px;
		}

		@media only screen and (max-width: 550px){
			#train_linker .btn {
				width: calc(100% - 20px);
			}

			#train_linker .btn_container {
				width: 100%;
			}
		}



		#engine_car_creator {
		    width: calc(100% - 80px);
		    max-height: calc(100% - 80px);
		    max-width: 600px;
		    padding: 10px;
		    margin: 30px;
		    border: 2px solid #1565C0;
		    border-radius: 10px;
		    background: white;
		    position: fixed;
		    overflow-y: overlay;
		    top: 0px;
		    left: 50%;
		    box-shadow: 0px 0px 10px 5px lightgrey;
		    -webkit-transform: translate(calc(-50% - 30px), 0);
		    transform: translate(calc(-50% - 30px),0);
		    min-height: 200px;
		}

		#engine_car_creator .header {
			width: calc(100% + 20px);
			padding: 10px 0px;
			padding-top: 10px;
			margin-top: -10px;
			margin-left: -10px;
			background: #1565C0;
			text-align: center;
			font-weight: bold;
			margin-bottom: 10px;
			color: white;
		}

		#engine_car_creator .field_container {
			float: left;
			width: calc(50% - 20px);
			background: #eee;
			border-radius: 3px;
			margin: 5px;
			padding: 5px;
		}

		#engine_car_creator .field_container span {
			font-weight: bold;
			display: block;
		}

		#engine_car_creator .field_container input {
			width: calc(100% - 10px);
			border: 1px solid grey;
			padding: 5px;
			margin-top: 2px;
			border-radius: 5px;
		}

		#engine_car_creator .field_container input:not(:first) {
			margin-bottom: 3px;
		}

		#engine_car_creator .radio_container {
			width: 100%;
		}

		#engine_car_creator .radio_button {
			width: calc(33% - 20px);
			padding: 5px;
			margin: 5px;
			border-radius: 5px;
			background: #ddd;
			text-align: center;
			font-size: smaller;
			font-weight: bold;
			float: left;
		}

		#engine_car_creator .radio_button input {
			width: 100%;
		}

		#engine_car_creator .btn {
			width: calc(33% - 20px);
			margin: 5px;
			padding: 5px;
			float:left;
			background: lightgrey;
			text-align: center;
			border-radius: 2px;
			cursor: pointer;
		}

		#engine_car_creator .btn_container {
			width: calc(100% - 40px);
			max-width:550px;
			margin:20px auto;
			height:38px;
		}

		@media only screen and (max-width: 550px){
			#engine_car_creator .btn {
				width: calc(100% - 20px);
			}

			#engine_car_creator .btn_container {
				width: 100%;
			}
		}

		#message_popup {
			top: -1px;
			position: fixed;
			transform: translate(-50%,0);
			left: 50%;
			padding-top: 10px;
			width: calc(100% - 10px);
			background: white;
			border: 1px solid grey;
			padding: 5px;
			max-width: 350px;
			box-shadow: 2px 2px 3px 0px #c5c5c5;
		}
		@media only screen and (min-width: 362px){
			#message_popup {
				border-bottom-left-radius: 5px;
				border-bottom-right-radius: 5px;
			}
		}

		.set-box .messages, #message_popup .messages {
			width: 100%;
			max-height: 250px;
			overflow: auto;
			display: flex;
			flex-wrap: wrap;
		}

		.set-box .messages .message, #message_popup .messages .message {
			width: calc(100% - 20px);
			min-width: 200px;
			padding: 5px;
			margin: 5px;
			min-height: 20px;
			max-height: 55px;
			background: lightgrey;
			border-radius: 3px;
			overflow: hidden;
			float:left;
			position: relative;
		}
		@media only screen and (min-width: 500px){
			.set-box .messages .message {
				width: calc(50% - 20px);
			}
		}

		.message .color-box {
			height: calc(100% + 10px);
			width: 30px;
			top: 0px;
			left: 0px;
			position: relative;
			float: left;
			margin-right: 10px;
			position: absolute;
		}

		.message .color-box.info {
			background: #03A9F4;
		}
		.message .color-box.warning {
			background: #FF9800;
		}
		.message .color-box.servere {
			background: #EF5350;
		}

		.message .header, .message .content {
			float: left;
			position: relative;
		}
		.message .header {
			left: 40px;
			width: calc(100% - 40px);
			font-weight: bold;
		}
		.message .content {
			left: 60px;
			width: calc(100% - 60px);
		}


		.masonry { /* Masonry container */
			column-count: 2;
			column-gap: 0;
		}

		@media only screen and (max-width: 1000px){
			.masonry {
				column-count: 1;
			}
		}

		.masonry > .masonry-item { /* Masonry bricks or child elements */
			display: inline-block;
		}

	</style>
</head>
<body>
	<div id="track" style="height:calc(100% - 90px);display:none"><canvas></canvas></div>
	<div id="trains" style="display:none;">
		<div class="control controlA">
			<div class="specs">
				<div class="img" style="background-image: url('./../trains/NoTrain.jpg');"></div>
				<div class="row name">No Train Selected</div>
				<div class="row control">
					<span class="type">...</span>
					<span class="route">...</span>
				</div>
			</div>
			<div style="width: 78px; right:0px; top:0px;position: absolute;height:100%">
				<div class="slider_containter sliderA">
					<div class="slider">
						<span class="slider_value">...</span>
					</div>
				</div>
			</div>
		</div>
		<div class="control controlB">
			<div class="specs">
				<div class="img" style="background-image: url('./../trains/NoTrain.jpg');"></div>
				<div class="row name">No Train Selected</div>
				<div class="row control">
					<span class="type">...</span>
					<span class="route">...</span>
				</div>
			</div>
			<div style="width: 78px; right:0px; top:0px;position: absolute;height:100%">
				<div class="slider_containter sliderB">
					<div class="slider">
						<span class="slider_value">...</span>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div id="train_hover" style="display:none">
		<div class="specs">
			<div class="img" style="background-image: url('./../trains/NoTrain.jpg');"></div>
			<div class="row name"></div>
			<div class="row control">
				<span class="type"></span>
				<span class="route"></span>
			</div>
			<div class="funcs" style="display:flex;width:100%; overflow-x: hidden; flex-wrap: wrap">
				<div class="func"></div>
				<div class="func"></div>
				<div class="func"></div>
				<div class="func"></div>
			</div>
		</div>
		<div style="width: 78px; right:0px; top:0px;position: absolute;height:100%">
			<div class="slider_containter">
				<div class="slider">
					<span class="slider_value">140</span>
				</div>
			</div>
		</div>
	</div>
	<div id="train_list">
		<div class="scroller">
			<div style="width:2270px;height:10px;"><!--content--></div>
		</div>
	</div>
	<div id="route" class="vertical" style="display:none;">
	</div>
	<div id="settings">
		<div class="settings_box masonry">
			<div class="set-box masonry-item">
				<div class="header">Broadcastflags</div>
				<div id="Broadcastflags" class="box-containter">
					<div class="checkbox bf80">
						<input type="checkbox"/>
						<div>X</div>
					</div>
					<div class="checkbox bf40">
						<input type="checkbox"/>
						<div>X</div>
					</div>
					<div class="checkbox bf20">
						<input type="checkbox"/>
						<div>X</div>
					</div>
					<div class="checkbox bf10">
						<input type="checkbox"/>
						<div>Admin</div>
					</div>
					<div class="checkbox bf08">
						<input type="checkbox"/>
						<div>Messages</div>
					</div>
					<div class="checkbox bf04">
						<input type="checkbox"/>
						<div>Switches</div>
					</div>
					<div class="checkbox bf02">
						<input type="checkbox"/>
						<div>Track</div>
					</div>
					<div class="checkbox bf01">
						<input type="checkbox"/>
						<div>Trains</div>
					</div>
				</div>
			</div>

			<div class="set-box masonry-item">
				<div class="header">Track layout</div>
				<div class="box-containter">
					<div class="buttonbox">
						Reload
					</div>
					<div class="collapsebox" done="websocket.cts_reload_previous(value);">
						Reload Previous
						<div class="0">20-05-2018</div>
						<div class="1">20-05-2018</div>
						<div class="2">20-05-2018</div>
						<div class="3">20-05-2018</div>
						<div class="4">20-05-2018</div>
						<div class="5">20-05-2018</div>
						<div class="6">20-05-2018</div>
						<div class="7">20-05-2018</div>
					</div>
					<div class="buttonbox">
						Add a module
					</div>
					<div class="buttonbox">
						Update / Remove module
					</div>
				</div>
			</div>

			<div class="set-box masonry-item">
				<div class="header">Trains / Engines</div>
				<div class="box-containter">
					<div class="buttonbox" onclick="Train.comp.open()">
						Add a Train
					</div>
					<div class="buttonbox">
						Update / Remove a Train
					</div>
					<div class="buttonbox" onclick="Train.engine_car_creator.open('E')">
						Add an Engine
					</div>
					<div class="buttonbox">
						Update / Remove an Engine
					</div>
					<div class="buttonbox" onclick="Train.engine_car_creator.open('C')">
						Add an Car
					</div>
					<div class="buttonbox">
						Update / Remove an Car
					</div>
				</div>
			</div>

			<div class="set-box masonry-item">
				<div class="header">Status</div>
				<div id="status_flags" class="box status-box-container">
					<div class="status-box f8000 green">Z21</div>
					<div class="status-box f4000 green">Websocket</div>
					<div class="status-box f2000 red">COM</div>
					<div class="status-box f1000 green">Client accept</div>

					<div class="status-box f0800 green">.</div>
					<div class="status-box f0400 green">.</div>
					<div class="status-box f0200 green">Digital</div>
					<div class="status-box f0100 green">Running</div>

					<div class="status-box f0080 green">.</div>
					<div class="status-box f0040 green">.</div>
					<div class="status-box f0020 green">.</div>
					<div class="status-box f0010 green">.</div>

					<div class="status-box f0008 green">Modules Coupled</div>
					<div class="status-box f0004 green">Modules Found</div>
					<div class="status-box f0002 green">.</div>
					<div class="status-box f0001 green">Trains Loaded</div>
				</div>
				<div class="box">
					<div id="log_box">
					</div>
				</div>
			</div>

			<div class="set-box masonry-item">
				<div class="header">Messages</div>
				<div class="messages"></div>
			</div>
		</div>
	</div>

	<div id="train_linker" style="display:none">
		<div class="header">Train Linker</div>

		<div class="selected">
			<div class="container">
				<div data="10">
					<div class="imgbox"></div>
				</div>
			</div>
			<div class="selector"></div>
		</div>
		<div class="btn_container">
			<div class="btn select">Select</div>
			<div class="btn close">Discard</div>
			<div class="btn add_cars">Create new train</div>
		</div>
	</div>

	<div id="train_compositor" style="display:none">
		<div class="header">Train Compositor</div>

		<div class="compositor">
			<div class="scroller">
				<div></div>
			</div>
		</div>
		<div class="btn_container">
			<div class="btn save">Save</div>
			<div class="btn close">Discard</div>
			<div class="btn add_cars">Add Car</div>
			<div class="btn add_engines">Add Engine</div>
		</div>
		<div class="cars selector"></div>
		<div class="engines selector"></div>
	</div>

	<div id="engine_car_creator" style="display:none">
		<div class="header">Some Title</div>
		<div style="width: 100%; float: left; display: flex; flex-wrap: wrap;">
			<div class="field_container" style="width: 100%;">
				<span>Images</span>
				<div style="width: 140px;height: 100px;margin: auto;border-top-left-radius: 5px;border-bottom-left-radius: 5px;overflow: hidden;background-size: cover;background-position: center;background-image: url(./../trains/6.png);"></div>
				<input type="file" id="icon"/>
				<div style="margin: auto; height: 50px; max-width: 100%;">
					<img src="./../trains/cars/traxx.png" style="height: 100%;">
				</div>
				<input type="file" id="img"/>
			</div>
			<div class="field_container name">
				<span>Name</span>
				<input type="text" placeholder="A name for the car"/>
			</div>
			<div class="field_container nr">
				<span>Nr</span>
				<input type="number" placeholder="Reference number"/>
			</div>
			<div class="field_container dcc">
				<span>DCC address</span>
				<input type="number" placeholder="DCC id"/>
			</div>
			<div class="field_container length">
				<span>Length</span>
				<input type="number" step="0.1" placeholder="length in cm"/>
			</div>
			<div class="field_container speed">
				<span>Max speed</span>
				<input type="number" placeholder="max speed in km/h"/>
			</div>
			<div class="field_container type">
				<span>Type</span>
				<div class="radio_container">
					<div class="radio_button"><input name="car_type" type="radio"/>Passenger</div>
					<div class="radio_button"><input name="car_type" type="radio"/>Both</div>
					<div class="radio_button"><input name="car_type" type="radio"/>Cargo</div>
				</div>
			</div>
		</div>

		<div class="btn_container">
			<div class="btn save">Save</div>
			<div class="btn save_new">Save + New</div>
			<div class="btn close">Discard</div>
		</div>
	</div>

	<div id="message_popup">
		<div class="messages"></div>
	</div>

	<div style="position: absolute;right: 0px;bottom: 0px;height: 50px;width: 50px;background: red" onClick='window.location.replace("");'></div> <!-- TODO remove -->
	<div class="menu" style="bottom:-185px;">
		<div class="Emergency_btn">
			<span>STOP</span>
			<img class="Emergency_Em_img" src="./img/stop_hand.png"/>
			<img class="Emergency_Es_img" src="./img/electrical.png"/>
		</div>
		<div class="menu_btn route">
			<img src="./img/route.png" width="26px" style="margin:12px;"/>
		</div>
		<div class="menu_btn trains">
			<img src="./img/trains.png" width="26px" style="margin:12px;"/>
		</div>
		<div class="menu_btn settings">
			<img src="./img/setting_cog.svg" width="26px" style="margin:12px;"/>
		</div>
	</div>
	<div class="menu_btn menu_toggle_btn" style="">
		<img src="./img/arrow_up.png"/>
	</div>

    <script src="./scripts/Sortable.js">
    </script>

	<script type="text/javascript">
		var Emergency = {
			enabled: false,
			type:"",
			timer:0,
			start: function(type,w=true){
				if(this.enabled == false){
					if(window.navigator.vibrate != undefined){
						window.navigator.vibrate([100,50,100,50,100]);
					}
					$('.Emergency_btn').off("click");
					$('.Emergency_btn').on("click",function(){Emergency.stop()});
					if(w == true && ws.connected)
						websocket.cts_Emergency();
					this.timer = setInterval(function(){
						if($('.Emergency_btn').css('background-color') == 'rgb(244, 67, 54)'){
							$('.Emergency_btn').css('background','#FFC107');
						}else{
							$('.Emergency_btn').css('background','#F44336');
						}
					},500);

					if(type == "Es"){
						$('.Emergency_btn').toggleClass("Emergency_Es");
						this.type = "Es";
					}else{
						$('.Emergency_btn').toggleClass("Emergency_Em");
						this.type = "Em";
					}

					this.enabled = true;
				}
			},
			stop: function(w=true){
				if(this.enabled){
					this.enabled = false;
					if(w == true && ws.connected){
						console.warn("RESEND");
						websocket.cts_release_Emergency();
					}
					$('.Emergency_btn').off("click");
					$('.Emergency_btn').on("click",function(){Emergency.start("Em")});
					clearInterval(this.timer);
					$('.Emergency_btn').css('background','#F44336');

					if($('.Emergency_btn').hasClass("Emergency_Es")){
						$('.Emergency_btn').toggleClass("Emergency_Es");
					}else{
						$('.Emergency_btn').toggleClass("Emergency_Em");
					}
				}
			}
		}

		var Menu = {
			min: -185,
			open: {track:true,trains:false,stations:false,settings:false},
			window_sizes: {"track":{min_h:500},"trains":{min_h:300},"route":{min_h:300},"settings":{min_h:700}},
			window_height: window.innerHeight - 90,
			init: function(){
				this.resize();
				if (this.window_type == 3){
					$('.menu .menu_btn.trains').css('display','none');
					this.min = -115;
				}else{
					$('.menu .menu_btn.trains').css('display','block');
					this.min = -185;
				}
				$('.menu').css("bottom",this.min+"px");
			},
			resize: function(){
				this.window_height = window.innerHeight - 90;
				this.window_width  = window.innerWidth;

				this.window_type = -1;

				if(this.window_width < 600 && this.window_height < 800){
					this.window_type = 0; //Mobile
				}
				else if(this.window_width < 1030 && this.window_height < 800){
					this.window_type = 1; //Tablet landscape
				}
				else if(this.window_width < 800 && this.window_height < 1010){
					this.window_type = 2; //Portrait Tablet
				}
				else{
					this.window_type = 3; //Large desktop
					if($('#route').hasClass("vertical")){
						$('#route').toggleClass("vertical");
						$('#route').toggleClass("horizontal");
					}
				}

				if(!$('#route').hasClass("vertical") && this.window_type != 3){
					$('#route').toggleClass("vertical");
					$('#route').toggleClass("horizontal");
				}

				$('#track, #trains, #route, #settings').css("height",this.window_height+"px");

				this.open_window();
			},
			toggle: function(){
				if($('.menu').hasClass("active")){
					$('.menu').css("bottom",this.min+"px");
				}else{
					$('.menu').css("bottom","25px");
				}
				$('.menu').toggleClass("active");
				$('.menu_toggle_btn img').toggleClass("active");
			},
			open_window: function(w){
				if($('#trains').hasClass("half")){
					$('#trains').toggleClass("half");
				}

				if(this.window_type == 0){
					//Mobile
					$('#track, #trains, #route, #settings').css("display","none");
					if(w == "trains"){
						this.open.trains = !this.open.trains;
						this.open.stations = false;
						this.open.settings = false;
					}
					if(w == "route"){
						this.open.stations = !this.open.stations;
						this.open.trains = false;
						this.open.settings = false;
					}
					if(w == "settings"){
						this.open.settings = !this.open.settings;
						this.open.trains = false;
						this.open.stations = false;
					}
					if(!this.open.trains && !this.open.stations && !this.open.settings){
						$('#track').css("display","block");
					}
					if(this.open.trains){
						$('#trains').css("display","block");
					}
					if(this.open.stations){
						$('#route').css("display","flex");
					}
					if(this.open.settings){
						$('#settings').css("display","block");
					}

					$('#track, #trains, #route').css("height",this.window_height+"px");

					return;
				}
				else if(this.window_type == 1){
					//Tablet landscape
					$('#track, #trains, #route, #settings').css("display","none");
					if(w == "trains"){
						this.open.trains = !this.open.trains;
					}
					if(w == "route"){
						this.open.stations = !this.open.stations;
					}
					if(w == "settings"){
						this.open.settings = !this.open.settings;
						this.open.stations = false;
						this.open.trains = false;
					}

					if(!this.open.stations && !this.open.trains && !this.open.settings){
						$('#track').css("height",this.window_height+"px");
						$('#track').css("display","block");
					}
					else if(this.open.stations){
						if(!this.open.trains){
							$('#route').css("display","flex");
							$('#route').css("width","100%");
						}
						else{
							if(!$('#trains').hasClass("half")){
								$('#trains').toggleClass("half");
							}

							$('#route').css("width","50%");
							$('#route').css("display","flex");
							$('#trains').css("display","block");
						}
					}
					else if(this.open.trains){
						if(!this.open.stations){
							$('#trains').css("display","block");
						}
						else{
							if(!$('#trains').hasClass("half")){
								$('#trains').toggleClass("half");
							}

							$('#route').css("width","50%");
							$('#route').css("display","flex");
							$('#trains').css("display","block");
						}
					}
					else if(this.open.settings){
						$('#settings').css("display","block");
					}

					$('#track, #trains, #route').css("height",this.window_height+"px");

					Canvas.resize()

					return;
				}
				else if(this.window_type == 2){
					//Portrait Tablet
					$('#trains, #route, #route, #settings').css("display","none");
					$('#track').css("display","block");
					if(w == "trains"){
						this.open.trains = !this.open.trains;
					}
					if(w == "route"){
						this.open.stations = !this.open.stations;
					}
					if(w == "settings"){
						this.open.settings = !this.open.settings;
						this.open.stations = false;
						this.open.trains = false;
					}

					if(!this.open.stations && !this.open.trains && !this.open.settings){
						$('#track').css("height",this.window_height+"px");
					}
					else if(this.open.stations){
						if(!this.open.trains){
							$('#route').css("display","flex");
							$('#route').css("height","500px");
							$('#route').css("width","100%");
							$('#track').css("height",(this.window_height-500)+"px");
						}
						else{
							if(!$('#trains').hasClass("half")){
								$('#trains').toggleClass("half");
							}

							$('#route').css("width","50%");
							$('#route').css("display","flex");
							$('#route').css("height","500px");
							$('#trains').css("display","block");
							$('#trains').css("height","500px");
							$('#track').css("height",(this.window_height-500)+"px");
						}
					}
					else if(this.open.trains){
						if(!this.open.stations){
							$('#trains').css("display","block");
							$('#trains').css("height","500px");
							$('#track').css("height",(this.window_height-500)+"px");
						}
						else{
							if(!$('#trains').hasClass("half")){
								$('#trains').toggleClass("half");
							}

							$('#route').css("width","50%");
							$('#route').css("display","flex");
							$('#route').css("height","500px");
							$('#trains').css("display","block");
							$('#trains').css("height","500px");
							$('#track').css("height",(this.window_height-500)+"px");
						}
					}
					else if(this.open.settings){
						$('#track').css("display","none");
						$('#settings').css("display","block");
					}

					Canvas.resize()

					return;
				}
				else{
					$('#trains, #route, #settings').css("display","none");
					$('#track').css("height",this.window_height+"px");
					if(w == "route"){
						this.open.stations = !this.open.stations;
					}
					if(w == "settings"){
						this.open.settings = !this.open.settings;
						this.open.stations = false;
					}

					if(this.open.stations){
						$('#route').css("display","flex");
						$('#route').css("height",355+"px");
						$('#track').css("height",(this.window_height-355)+"px");
						
					}
					else if(this.open.settings){
						$('#track').css("display","none");
						$('#settings').css("display","block");
					}
					else{
						$("#track").css("display","block");
					}
					

					Canvas.resize();

					return;
				}
			}
		}

		var Train = {
			trains: [], //Train compositions
			engines: [
				// {name:"TRAXX",dcc:300,img:"6.png",icon:"cars/traxx.png"},
				// {name:"TRAXX",dcc:301,img:"6.png",icon:"cars/traxx.png"},
				// {name:"ns 1800",dcc:1800,img:"cars/ns1800.png",icon:"cars/ns1800.png"},
				// {name:"ns 1700",dcc:1700,img:"cars/ns1700.png",icon:"cars/ns1700.png"},
				// {name:"Koploper 4",dcc:1252,img:"cars/icm_4_.png",icon:"cars/icm_4.png"},
				// {name:"Koploper 3",dcc:1253,img:"cars/icm_3_.png",icon:"cars/icm_3.png"},
				// {name:"ICE3",dcc:100,img:"cars/ice.png",icon:"cars/ice.png"},
				// {name:"Thalys",dcc:10,img:"cars/thalys.png",icon:"cars/thalys.png"}
			],
			cars: [
				// {name:"ICR 2de klas",nr:13333,img:"cars/ns_2nd_class.png",icon:"cars/ns_2nd_class.png"},
				// {name:"ICR 1de klas",nr:13334,img:"cars/ns_1nd_class.png",icon:"cars/ns_1nd_class.png"},
				// {name:"DB",nr:10243,img:"cars/db.png",icon:"cars/db.png"}
			],
				
			engine: [
				{name:"Koploper",dcc:3515,id:2,speed:100,max_speed:160,route:{S:-1,P:0},funcs:[{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0}]},
				{name:"TGV",     dcc:1200,id:3,speed:100,max_speed:350,route:{S:-1,P:0},funcs:[{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0}]},
				{name:"Eurostar",dcc:4123,id:4,speed:100,max_speed:300,route:{S:-1,P:0},funcs:[{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0}]},
				{name:"Hondekop",dcc:300, id:5,speed:80, max_speed:140,route:{S:-1,P:0},funcs:[{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0}]},
				{name:"TRAXX",dcc:301, id:6,speed:80, max_speed:160,route:{S:-1,P:0},funcs:[{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0},{t:'P',a:0}]}],
			selected: [],
			select: function(id){
				var n = false;
				if(this.selected[0] == id || this.selected[1] == id){
					n = true;
				}
				console.log("Select train "+id);
				$('#train_list .train_list_box.active').toggleClass("active");
				if(Menu.window_type == 0 || Menu.window_type == 3){
					this.selected = [id];
				}
				else{
					if(! this.selected.includes(id)){
						if(this.selected.length == 2){
							this.selected = [this.selected.pop()];
						}
						this.selected.push(id);
					}
					else{
						var tmp = this.selected[0];
						this.selected[0] = this.selected[1];
						this.selected[1] = tmp;
					}
					console.log(this.selected);
				}
				$.each(this.selected,function(i,v){
					$('#train_list #Tr'+v+'.train_list_box').toggleClass("active");
				});

				if(Menu.window_type != 3){
					if(this.selected[0] != undefined){
						var train = this.trains[this.selected[0]];
						$('#trains .controlA .name').text(train.name);
						$('#trains .controlA .specs .img').css('background-image',"url('./../trains/"+train.img+"'");
						$('#trains .controlA .control .type').text(((train.control & 0xC0) == 0)?"Manual":(((train.control & 0xC0) == 0x40)?"Semi-auto":"Full-auto"));
					}

					if(this.selected[1] != undefined){
						var train = this.trains[this.selected[1]];
						$('#trains .controlB .name').text(train.name);
						$('#trains .controlB .specs .img').css('background-image',"url('./../trains/"+train.img+"'");
						$('#trains .controlB .control .type').text(((train.control & 0xC0) == 0)?"Manual":(((train.control & 0xC0) == 0x40)?"Semi-auto":"Full-auto"));
					}

					this.update();
				}
				else{
					if($('#train_hover').css("display") == "none"){
						$('body').on("mousedown", Train.hide);
						$('#train_hover').css("display","block")
					}
					else if(n){
						$('#train_hover').css("display","none");
						$('body').off("mousedown", Train.hide);
						return;
					}

					pos = $('#train_list #Tr'+this.selected[0]+'.train_list_box').position()

					$('#train_hover').css("left",(pos.left-20)+"px"); //272 - 252
					$('#train_hover').css("bottom","120px")

					var train = this.trains[this.selected[0]];

					$('#train_hover .specs .img').css('background-image',"url('./../trains/"+train.img+"'");
					$('#train_hover .specs .name').text(train.name);
					$('#train_hover .control .type').text(((train.control & 0xC0) == 0)?"M":(((train.control & 0xC0) == 0x40)?"SA":"FA"));
					$('#train_hover .control .route').text((train.route.S >= 0)?(train.route.S + ":" + train.route.P):"No Route");

					this.update();
				}
			},
			init: function(){
				$('.train_list_box').off("click");
				$('#train_list .scroller').empty();

				this.comp.init();
				this.linker.init();
				this.engine_car_creator.init();

				this.update_list();
			},
			resize: function(){
				$('#train_compositor .selector').css("max-height",(window.innerHeight - 80 - 38 - 106 - 38 - 40)+"px");
			},
			setRoute: function(dcc,from,to){
				console.warn("Implement: Train set route:",dcc,from,to);
			},
			route: function(tid,DestM,DestS){
				console.warn("Implement: Train "+tid+" has a route to "+DestM+"-"+DestS);
			},
			import: function(data){
				console.warn("Implement")
			},

			comp:{
				index: 0,
				list: [],
				init: function(){
					$('#train_compositor .selector').hide();

					$('#train_compositor .btn.add_cars').on("click",this.toggleCar);
					$('#train_compositor .btn.add_engines').on("click",this.toggleEngines);
					$('#train_compositor .btn.save').on("click",this.save);
					$('#train_compositor .btn.close').on("click",this.close);

                    this.update_list();

					$('#train_compositor .compositor .scroller > div').empty();
				},

                update_list: function(){
                    $('#train_compositor .engines.selector, #train_compositor .cars.selector').empty();
                    $.each(Train.engines, function(i,v){
                        text =  '<div index="'+i+'" class="list_box">';
                        text += '<div  class="img" style="background-image: url(\'./../trains/'+v.img+'\');"></div>'
                        text += '<div class="name">'+v.name+'</div>';
                        text += '<div class="id">'+v.dcc+'</div>';
                        text += '</div>';

                        $('#train_compositor .engines.selector').append(text);
                    });

                    $.each(Train.cars, function(i,v){
                        text =  '<div index="'+i+'" class="list_box">';
                        text += '<div  class="img" style="background-image: url(\'./../trains/'+v.img+'\');"></div>'
                        text += '<div class="name">'+v.name+'</div>';
                        text += '<div class="id">'+v.nr+'</div>';
                        text += '</div>';

                        $('#train_compositor .cars.selector').append(text);
                    });

                    $('#train_compositor .cars .list_box, #train_compositor .engines .list_box').on("click",this.add);
                },

				toggleCar: function(){
					if($('#train_compositor .cars.selector').css("display") == "none"){
						$('#train_compositor .cars.selector').show();
						$('#train_compositor .engines.selector').hide();
					}
					else{
						$('#train_compositor .cars.selector').hide();
					}
				},
				toggleEngines: function(){
					if($('#train_compositor .engines.selector').css("display") == "none"){
						$('#train_compositor .engines.selector').show();
						$('#train_compositor .cars.selector').hide();
					}
					else{
						$('#train_compositor .engines.selector').hide();
					}
				},
				add: function(evt){
					var index = parseInt($(evt.currentTarget).attr("index"));
					var text = "";
					if($(evt.currentTarget).parent().hasClass("engines")){
						console.log("Add engine");
						text = '<div class="box new b'+Train.comp.index+'">' +
							   '<img src="./../trains/'+Train.engines[index].icon+'"/>' +
							   '<div class="name">'+Train.engines[index].name+' - '+Train.engines[index].dcc+'</div>' +
							   '<div class="control">' +
							   '<div class="cbtn l">&lt;</div>' +
							   '<div class="cbtn b">b</div>' +
							   '<div class="cbtn r">&gt;</div>' +
							   '</div></div>';
						Train.comp.list.push({t:"E",i:Train.comp.index});
					}
					else{
						console.log("Add car");
						text = '<div class="box new b'+Train.comp.index+'">' +
							   '<img src="./../trains/'+Train.cars[index].icon+'"/>' +
							   '<div class="name">'+Train.cars[index].name+'</div>' +
							   '<div class="control">' +
							   '<div class="cbtn l">&lt;</div>' +
							   '<div class="cbtn b">b</div>' +
							   '<div class="cbtn r">&gt;</div>' +
							   '</div></div>';
						Train.comp.list.push({t:"C",i:Train.comp.index});
					}
					Train.comp.index++;
					$('#train_compositor .compositor .scroller > div').append(text);

					var width_sum = 0;
					$.each($('#train_compositor .compositor img'),function(){
						if($(this).width() < 20){
							width_sum += 200
						}
						width_sum += $(this).width()
						console.log($(this).width())
						width_sum += 10
					});

					$('#train_compositor .compositor .scroller > div').css("width",width_sum + "px");


					$('#train_compositor .compositor .box.new .cbtn.b').on("click",Train.comp.del);


					$('#train_compositor .compositor .box.new').toggleClass("new");
				},
				del: function(evt){
					Train.comp.list[parseInt($(evt.currentTarget).parent().parent()[0].classList[1].slice(1))] = undefined;
					$('.cbtn',$(evt.currentTarget).parent().parent()).off();
					$(evt.currentTarget).parent().parent().remove();
				},
				open: function(){
					$('#train_compositor').show();
					Train.comp.list = [];
					$('#train_compositor .compositor .scroller > div').empty();
				},
				save: function(evt){
					console.warn("Implement Train compositor save");
					$('#train_compositor').hide();
				},
				close: function(evt){
					$('#train_compositor').hide();
				}
			},

			linker:{
				message: undefined,

				init: function(){
					$('#train_linker .selected .container').on("click",function(){
						$('#train_linker .selected .selector').toggleClass("active");
					});

                    this.update_list();

                    $('#train_linker .btn.select').on("click", this.done);
                    $('#train_linker .btn.close').on("click", this.close);
                    $('#train_linker .btn.add_cars').on("click", Train.comp.open);
				},

                update_list: function(){

                    $('#train_linker .selected .selector').empty();

                    Train.trains.forEach(function(e,i){
                        text = '<div train="'+i+'">' +
                               '<div class="imgbox"><div class="scroller"><div style="white-space: nowrap;">';

                        e.link.forEach(function(e2,i2){
                            if((String.fromCharCode(e2[0]) == "E" || String.fromCharCode(e2[0]) == "e") && Train.engines[e2[1]] != undefined){
                                text += '<img src="./../trains/'+Train.engines[e2[1]].icon+'"/>';
                            }else if(Train.cars[e2[1]] != undefined){
                                text += '<img src="./../trains/'+Train.cars[e2[1]].icon+'"/>';
                            }
                        })
                                
                        text += '</div></div></div>'+
                                '<div class="textbox"><span class="name">'+e.name+'</span><span class="dcc">'+e.dcc+'</span></div>'+
                                '</div>'

                        $('#train_linker .selected .selector').append(text);
                    });

                    Train.engines.forEach(function(e,i){
                        text = '<div engine="'+i+'">' +
                            '<div class="imgbox"><div class="scroller"><div style="white-space: nowrap;">'+
                                '<img src="./../trains/'+e.icon+'"/>'+
                            '</div></div></div>'+
                            '<div class="textbox"><span class="name">&nbsp;&nbsp;&nbsp;'+e.name+'</span><span class="dcc">'+e.dcc+'</span></div>'+
                        '</div>'

                        $('#train_linker .selected .selector').append(text);
                    });

                    $('#train_linker .selected .selector > div').on("click", this.select);

                },

                select: function(evt){
                    train = $(evt.currentTarget).clone();
                    $('#train_linker .selected .container').off();
                    $('#train_linker .selected .container').remove();
                    $('#train_linker .selected').prepend(train);
                    $('#train_linker .selected > div:first-child').toggleClass("container");
                    $('#train_linker .selected .selector').toggleClass("active");

                    $('#train_linker .selected .container').on("click",function(){
                        $('#train_linker .selected .selector').toggleClass("active");
                    });
                },

                done: function(){
                    console.log(parseInt($('#train_linker .selected .container').attr("train")))
                    console.log(parseInt($('#train_linker .selected .container').attr("engine")));
                    Train.linker.close();
                },

                open: function(msg){
                	this.message = msg.id;
					$('#train_linker .header').html("Train "+msg.data[0]+" on "+msg.data[1] + ":" + msg.data[2]);

                    $('#train_linker .selected .container').empty();
                    $('#train_linker').show();
                },

                close: function(){
                    console.log("CLOSE linker")
                    $('#train_linker').hide();
                }
			},

			engine_car_creator:{
				init: function(){
                    $('#engine_car_creator .btn.save').on("click", this.done);
                    $('#engine_car_creator .btn.save_new').on("click", this.done_n);
                    $('#engine_car_creator .btn.close').on("click", this.close);
				},

				upload: function(){
					var file = $("#file1").get(0).files[0];
					var formdata = new FormData();
					formdata.append("file1", file);
					formdata.append("name", name);
					var ajax = new XMLHttpRequest();
					ajax.addEventListener("load", function(){}, false);
					ajax.addEventListener("error", function(){}, false);
					ajax.addEventListener("abort", function(){}, false);
					ajax.open("POST", "./train_img_upload.php");
					ajax.send(formdata);
				},

				done: function(close = true){

					
					if(close && close.target == undefined){
						this.close();
					}
				},
				done_n: function(){
					this.done(false);
					// some_extra_shit
				},
				close: function(){
					$('#engine_car_creator').hide();
				},
				open: function(type){
					$('#engine_car_creator').show();

					if(type == "E"){
						$('#engine_car_creator .field_container.nr').hide();
						$('#engine_car_creator .field_container.dcc').show();
					}
					else{
						$('#engine_car_creator .field_container.nr').show();
						$('#engine_car_creator .field_container.dcc').hide();
					}

				}
			},

			// System Events
			update_list: function(){
				$('#train_list .train_list_box').off("click");
				$('#train_list .slider_containter').off("mousedown touchstart");

                var notFirst;

                Train.trains.forEach(function(e,i){
                    if(Train.trains[i].dcc == "" || Train.trains[i].dcc == undefined){
                    	Train.trains[i].dcc = "";
                        notFirst = false;
                        e.link.forEach(function(e2,i2){
                            if(String.fromCharCode(e2[0]) == "E" || String.fromCharCode(e2[0]) == 'e'){
                                if(notFirst == true){
                                    Train.trains[i].dcc += ", "
                                }
	                            if(e.img == "" || e.img == undefined){
	                            	Train.trains[i].img = Train.engines[ e2[1] ].img;
	                            }
                                notFirst = true;
                                Train.trains[i].dcc += Train.engines[ e2[1] ].dcc;
                            }
                        });
                    }
                });

				var content = "";
				var width = 0;

				$.each(this.trains,function(i,v){
					if(v.use == false){
						return true;
					}
					content += '<div id="Tr'+i+'" class="train_list_box">' +
								'<div  class="img" style="background-image: url(\'./../trains/'+v.img+'\');"></div>' +
								'<span class="id">'+v.dcc+'</span>' +
								'<span class="name">'+v.name+'</span>' +
							   '</div>';
					width += 252;
				});

				content = '<div style="width:'+width+'px;height: 10px">' + content + '</div>';

				$('#train_list .scroller').html(content);

				$('.train_list_box').on("click",function(evt){
					Train.select(parseInt(evt.currentTarget.id.slice(2)));
				});

				$('.slider_containter').on("mousedown touchstart",function(evt){
					Train.slider(evt);
					$('.slider_containter').on("mousemove touchmove",Train.slider);
					$('.slider_containter').on("mouseup touchend",function(evt){
						Train.slider(evt);
						$('.slider_containter').off("mousemove mouseup touchmove touchend");
					});
				});
			},

			update: function(data){
				if(Menu.window_type != 3){
					var train_data = this.trains[this.selected[0]];
					if(train_data != undefined){
						$('#trains .controlA .slider').css('height',(train_data.speed/train_data.max_speed)*100+"%");
						$('#trains .controlA .slider_value').text(Math.round(train_data.speed));

						if(((train_data.speed/train_data.max_speed) < 0.1 && !$('#trains .controlA .slider_value').hasClass("inverse")) || (train_data.speed/train_data.max_speed) >= 0.1 && $('#trains .controlA .slider_value').hasClass("inverse")){
							$('#trains .controlA .slider_value').toggleClass("inverse")
						}
					}


					var train_data = this.trains[this.selected[1]];
					if(train_data != undefined){
						$('#trains .controlB .slider').css('height',(train_data.speed/train_data.max_speed)*100+"%");
						$('#trains .controlB .slider_value').text(Math.round(train_data.speed));

						if(((train_data.speed/train_data.max_speed) < 0.1 && !$('#trains .controlB .slider_value').hasClass("inverse")) || (train_data.speed/train_data.max_speed) >= 0.1 && $('#trains .controlB .slider_value').hasClass("inverse")){
							$('#trains .controlB .slider_value').toggleClass("inverse")
						}
					}
				}
				else{
					var train_data = this.trains[this.selected[0]]
					$('#train_hover .slider').css('height',(train_data.speed/train_data.max_speed)*100+"%");
					$('#train_hover .slider_value').text(Math.round(train_data.speed));

					if(((train_data.speed/train_data.max_speed) < 0.1 && !$('#train_hover .slider_value').hasClass("inverse")) || (train_data.speed/train_data.max_speed) >= 0.1 && $('#train_hover .slider_value').hasClass("inverse")){
						$('#train_hover .slider_value').toggleClass("inverse")
					}
				}
			},

			// User Events
			slider: function(evt){
				var clickY;
				console.log(evt)
				if(evt.type == "touchmove" || evt.type == "mousemove" || evt.type == "touchstart" || evt.type == "mousedown"){
					if(evt.clientY == undefined){
						clickY = $(evt.currentTarget).offset().top - evt.touches[0].clientY
						evt.preventDefault();
						evt.stopPropagation();
					}
					else{
						clickY = $(evt.currentTarget).offset().top - evt.clientY
						evt.preventDefault();
						evt.stopPropagation();
					}
					var procent = ((clickY + $(evt.currentTarget).height())/$(evt.currentTarget).height())
					procent = (procent < 0)?0:((procent > 1)?1:procent);
					if($(evt.currentTarget).hasClass("sliderB")){
						Train.trains[Train.selected[1]].speed = procent*Train.trains[Train.selected[1]].max_speed;
					}
					else{
						Train.trains[Train.selected[0]].speed = procent*Train.trains[Train.selected[0]].max_speed;
					}
				}
				if($(evt.currentTarget).hasClass("sliderB")){
					if(evt.type != "touchmove" && evt.type != "mousemove"){
						websocket.cts_train_speed(Train.trains[Train.selected[1]].id, 0, Math.round((Train.trains[Train.selected[1]].speed/Train.trains[Train.selected[1]].max_speed)*127));
					}
				}
				else{
					if(evt.type != "touchmove" && evt.type != "mousemove"){
						websocket.cts_train_speed(Train.trains[Train.selected[0]].id, 0, Math.round((Train.trains[Train.selected[0]].speed/Train.trains[Train.selected[0]].max_speed)*127));
					}
				}
				Train.update();

				return false;
			},
			hide: function(event){
				if(!$(event.target).closest('#train_hover').length && !$(event.target).hasClass("train_list_box") && !$(event.target.parentNode).hasClass("train_list_box")) {
			        if($('#train_hover').is(":visible")) {
			            $('#train_hover').hide();
						$('body').off("mousedown", Train.hide);
			        }
			    }
			},
		}

		var Stations = {
			// Platform state: 0 = free, 1 = stopped, 2 = leaving, 3 = arriving
			data: [{name:"Small Station",platforms:[{name:"Spoor 1",type:"P",parts:2,state:0},{name:"Spoor 2",type:"P",parts:2,state:1},{name:"Spoor 3",type:"P",parts:2,state:2},{name:"Spoor 4",type:"P",parts:2,state:3},{name:"Spoor 5",type:"P",parts:2,state:0}]},
				{name:"Small Yard",platforms:[{name:"Siding",type:"Y",parts:1,state:0},{name:"Mainline east",type:"C",parts:1,state:0},{name:"Mainline west",type:"C",parts:1,state:0}]}],
			selected: [],
			init: function(){
				$('#route .station').off("click");
				$('#route').empty();

				var content = "";

				$.each(this.data,function(i,v){

					content += '<div class="station_Box">' +
								'<div class="header">'+v.name+'</div><div class="scroller">';

					$.each(v.platforms,function(i2,v2){
						content += '<div class="station" id="St'+i+"-"+i2+'">'
						content += '<div class="station_type ';
						content += ((v2.type == "P")?"person":((v2.type == "C")?"cargo":"storage"))
						content += '"></div><div class="station_name">'+v2.name+'</div>' +
									'<div class="station_DCC_id">';
						content += '...';
						content += '</div>' +
									'<div class="station_state"><small>';
						content += ((v2.state == 1)?"Stopped":((v2.state == 2)?"Leaving":((v2.state == 3)?"Arriving":"")));
						content += '</small> ..:..</div>'
						content += (v2.parts == 1)?('<div class="length_1 lengthL lengthR"></div>'):('<div class="length_2 lengthL">a</div><div class="length_2 m"></div><div class="length_2 lengthR">b</div>');
						content += '</div>';
					});

					content += '</div></div>';
				});

				$('#route').html(content);

				$('#route .station').on("click",function(evt){Stations.click(evt);});
			},

			import: function(data){
				console.warn("Implement: station import");
			},

			select: function(ids){
				Sid = parseInt(ids[0]); // Station nr
				Pid = parseInt(ids[1]); // Platform nr

				if(!$('#route #St'+Sid+'-'+Pid+'.station').hasClass("active")){
					if(this.selected.length == 1){
						if(ids[2] != undefined){
							$('#route #St'+Sid+'-'+Pid+' .length_'+this.data[Sid].platforms[Pid].parts).toggleClass("active");

							this.selected.push({S:Sid,P:Pid,sP:ids[2]});

							if(this.selected.length == 2){
								$('#route .station.active').toggleClass("active");
								$('#route .station .active').toggleClass("active");
								Train.setRoute(this.selected[0].dcc,this.selected[0],this.selected[1]);
								this.selected = [];
							}
						}
						else if(this.data[Sid].platforms[Pid].parts > 1){
							$('#route #St'+Sid+'-'+Pid+' .length_'+this.data[Sid].platforms[Pid].parts).toggleClass("active");

						}
					}
					else if(this.data[Sid].platforms[Pid].state == 1){
						this.selected.push({S:Sid,P:Pid});
						$('#route #St'+Sid+'-'+Pid+'.station').toggleClass("active");
					}
					else{
						if(Train.selected.length >= 1){
							Train.setRoute(Train.data[Train.selected[0]].dcc,undefined,{S:Sid,P:Pid});
							$('#route #St'+Sid+'-'+Pid+'.station').toggleClass("active");
							setTimeout(function(){$('#route #St'+Sid+'-'+Pid+'.station').toggleClass("active");},500);
						}
					}
				}
			},
			click: function(evt){
				obj = evt.currentTarget.id.slice(2).split("-");
				if($(evt.target).hasClass("length_1") || $(evt.target).hasClass("length_2")){
					obj.push($(evt.target).text());
				}
				this.select(obj)
			}
		}

		var Messages = {
			open_messages: [],
			popup_messages: [],
			message_counter: 0,

			add: function(msg){

				var id = msg.id;
				this.open_messages[id] = msg;

				//Check type
				if(msg.type == 0){ //New train
					msg.data[0] // Folow ID
					msg.data[1] // Found on module
					msg.data[2] // and Section
					text = '<div class="message mID'+id+'">'+
							'<div class="color-box warning"></div>'+
							'<div class="header">A new Train</div>'+
							'<div class="content">Near '+msg.data[1]+':'+msg.data[2]+'</div>'+
						   '</div>'

					$('#settings .messages').append(text);
					this.show(text,msg.id);

					$('#settings .messages .mID'+id+', #message_popup .messages .mID'+id).css("cursor", "pointer");
					$('#settings .messages .mID'+id+', #message_popup .messages .mID'+id).on("click", function(evt){
						Train.linker.open(msg);
						Messages.hide(msg);
					});

					setTimeout(function(){Messages.hide(msg);},5000);
				}
				else if(msg.type == 0x20){ //Split train in yard
					msg.data[0] // Folow ID
					msg.data[1] // Found A on module
					msg.data[2] // and Section
					msg.data[3] // Found B on module
					msg.data[4] // and Section
					text = '<div class="message mID'+id+'">'+
							'<div class="color-box warning"></div>'+
							'<div class="header">Train has split in a yard</div>'+
							'<div class="content">Near '+msg.data[1]+':'+msg.data[2]+'</div>'+
						   '</div>'

					$('#settings .messages').append(text);
					this.show(text,msg.id);
					setTimeout(function(){Messages.hide(msg);},5000);
				}
				else if(msg.type == 0x40){ //Split train on mainline
					msg.data[0] // Folow ID
					msg.data[1] // Found A on module
					msg.data[2] // and Section
					msg.data[3] // Found B on module
					msg.data[4] // and Section
					text = '<div class="message mID'+id+'">'+
							'<div class="color-box servere"></div>'+
							'<div class="header">Train has split on main line</div>'+
							'<div class="content">Near '+msg.data[1]+':'+msg.data[2]+'</div>'+
						   '</div>'

					$('#settings .messages').append(text);
					this.show(text,id);
				}
				else if(msg.type == 0xFF){ // Disconnected
					text = '<div class="message mID'+id+'">'+
							'<div class="color-box servere"></div>'+
							'<div class="header">Reconnecting</div>'+
							'<div class="content"></div>'+
						   '</div>'

					$('#settings .messages').append(text);
					this.show(text,id);
				}
                else{
                    console.warn("add Messages.add() type "+msg.type);
                }
				if(msg[0] == 0){
					setTimeout(function(){Messages.hide(id);},5000);
				}

				return id;
			},

			show: function(text,id){
				$('#message_popup').show();
				this.popup_messages.push(id);
				$('#message_popup .messages').append(text);
			},

			hide: function(msg){
				if(this.popup_messages.indexOf(msg.id) >= 0){
					console.warn("HIDE");
					$('#message_popup .messages .mID'+msg.id).remove();
					this.popup_messages.pop(this.popup_messages.indexOf(msg.id));
					if(this.popup_messages.length == 0)
						$('#message_popup').hide();
				}
			},

			update: function(msg){
				console.warn("add Messages.update()");
			},

			remove: function(msg_id){
				this.open_messages.pop(this.open_messages.indexOf(msg_id));
				$('#message_popup .messages .mID'+msg_id.id).off();

				$('#settings .messages .message.mID'+msg_id.id).remove();
				this.hide(msg_id);
			},

			clear: function(){
				this.open_messages.forEach(function(element){
					Messages.remove(element);
				});
				this.open_messages = [];
			}
		}

		var small_dev = false;

		$('.Emergency_btn').on("click",function(){Emergency.start("Em");return false});
		$('.menu_toggle_btn').on("click",function(){Menu.toggle();});

		$('.menu_btn.trains').on("click",function(){Menu.open_window("trains")});
		$('.menu_btn.route').on("click",function(){Menu.open_window("route")});
		$('.menu_btn.settings').on("click",function(){Menu.open_window("settings")});

		$('.train_list_box').on("click",function(evt){Train.select(parseInt(evt.currentTarget.id.slice(2)));});

		$('#route .station').on("click",function(evt){Stations.click(evt)});

		$('#settings .set-box .collapsebox').on("click",function(evt){
			if(!$(evt.target).hasClass("collapsebox")){
				// console.log(evt);
				var value = parseInt(evt.target.className);
				eval(evt.currentTarget.getAttribute("done"));
			}
			$(evt.currentTarget).toggleClass('active');
		});

		$(document).on("keydown",function(evt){
			if($(evt.target).is("textarea") || $(evt.target).is("input"))
				return
			if(evt.key == "s" || evt.key == "S"){
				Emergency.start('Em');
			}
		});

		//alert(window.innerWidth+","+window.innerHeight)

		$(document).resize(function(){
			Menu.resize();
			Train.resize();
		});

		var container = $("#train_compositor .compositor .scroller > div")[0];
		var sort = Sortable.create(container, {
		  animation: 150, // ms, animation speed moving items when sorting, `0` - without animation
		  handle: 'img',
		  draggable: ".box", // Specifies which items inside the element should be sortable
		  onUpdate: function (evt/**Event*/){
		     var item = evt.item; // the current dragged HTMLElement
		     console.log(evt);
		  }
		});

		log_lines = [];

		function log_data(data){
			//$('#log_box').html(data.replace(/(\n)+/g,'<br/>'));
			// lines = data.split(/(\n)/);
			lines = data.split("\n");
			for(var i = log_lines.length; i < lines.length; i++){
				if(lines[i] == ""){
					continue;
				}
				if(/CRITICAL/.test(lines[i])){
					lines[i] = '<pre style="color: red;font-weight: bold;">'+lines[i]+'</pre>';
				}
				else if(/ERROR/.test(lines[i])){
					lines[i] = '<pre style="color: red">'+lines[i]+'</pre>';
				}
				else if(/WARNING/.test(lines[i])){
					lines[i] = '<pre style="color: orange">'+lines[i]+'</pre>';
				}
				else{
					lines[i] = '<pre>'+lines[i]+'</pre>';
				}
				$('#log_box').append(lines[i]);
				log_lines.push(lines[i]);
			}

			if((document.getElementById('log_box').scrollTop - document.getElementById('log_box').scrollHeight + document.getElementById('log_box').clientHeight) > -10){
				document.getElementById('log_box').scrollTo(0,document.getElementById('log_box').scrollHeight+document.getElementById('log_box').clientHeight);
			}
		}


		$(document).ready(function(){
			Canvas.init();
			if(window.innerWidth < 764){
				Canvas.rescale(0.5);
			}

			Train.init();
			Stations.init();
			Menu.init();
			Train.resize();

			Canvas.calc_dotmatrix();

			Canvas.dimensions.content_width = 1300;
			Canvas.dimensions.content_height= 460;
			Canvas.dimensions.box_width  = Canvas.dimensions.content_width;
			Canvas.dimensions.box_height = Canvas.dimensions.content_height;
			Canvas.dimensions.width = $('#track').width();
			Canvas.dimensions.height = $('#track').height();
			Canvas.dimensions.ofX = Canvas.dimensions.width/2-Canvas.dimensions.content_width/2;
			Canvas.calc_limits();

			Canvas.update_frame();

			$('#settings .set-box .checkbox').on("click",websocket.cts_BroadcastFlag);

			setInterval(function(){
				$.ajax({
				    url: "./../log.txt",
				    success: function (data){
				        log_data(data);
				    }
				});
			},5000);
		});

			// document.ontouchmove = function(event){
			//     event.preventDefault();
			// }


		var c;

		var Canvas = {

			radia: [68.2843],
			ds: -8.28,
			ro: [],
			c: undefined,
			canvas: undefined,
			dimensions: {scale:1,width:0,height:0,ofX:0,ofY:0,content_width:0,content_height:0,box_width:0,box_height:0,x_left:0,x_right:0,y_top:0,y_bottom:0},
			init_calc: function(){
				this.ro = [{x:this.radia[0]*Math.cos(Math.PI*0.25),y:this.radia[0] - this.radia[0]*Math.sin(Math.PI*0.25),yr:this.radia[0]*Math.sin(Math.PI*0.25)}];
				this.ro[0].l = Math.sqrt(Math.pow(this.ro[0].x-this.ds,2)+Math.pow(this.ro[0].y,2));
			},
			init: function(){
				this.canvas = document.querySelector('canvas');
				this.c = this.canvas.getContext('2d');
				c = this.c;

			    this.canvas.height = $('#track').height();
				this.canvas.width = $('#track').width();

				$('canvas').on('mousedown',this.evt_mousedown);
				$('canvas').on('mouseup',this.evt_mouseup);

				$('canvas').on("mousewheel",this.evt_scrolled)

				$('canvas').on("touchstart",this.evt_drag_start);
				$('canvas').on("touchmove",this.evt_drag_move);
				$('canvas').on("touchend",this.evt_drag_end);
			},
			resize: function(){
				console.log("resize");

				tmp_scale = this.dimensions.scale;
				this.rescale(1);

			    this.canvas.height = $('#track').height();
				this.canvas.width  = $('#track').width();

				this.dimensions.width = this.canvas.width;
				this.dimensions.height = this.canvas.height;
				
				this.dimensions.ofX = 0.5*this.dimensions.width-0.5*this.dimensions.content_width;
				this.dimensions.ofY = 0;

				this.calc_limits();

				this.rescale(tmp_scale);

				this.update_frame();
			},
			rescale: function(new_scale){
				c.scale(1/this.dimensions.scale,1/this.dimensions.scale);

				this.dimensions.scale = new_scale;
				c.scale(this.dimensions.scale,this.dimensions.scale);

				this.dimensions.ofX = 0.5*this.dimensions.width/this.dimensions.scale-0.5*this.dimensions.content_width;
				this.dimensions.ofY = 0;

				this.calc_limits();

				this.moved();

				this.update_frame();
			},

			calc_limits: function(){
				if(this.dimensions.content_width == 0 || this.dimensions.content_height == 0){
					return;
				}
				var margin = 20/this.dimensions.scale;
				this.dimensions.x_left   = -margin;
				this.dimensions.x_right  = this.dimensions.content_width+margin;
				this.dimensions.y_top    = 0;
				this.dimensions.y_bottom = this.dimensions.content_height+margin;
			},

			calc_dotmatrix: function(){
				$.each(modules,function(module,module_v){
					$.each(module_v.data,function(i,v){
						var coords = [];
						var block_list = [];
						var switch_list = [];
						if(v.type == "line"){
							coords.push({x:v.x,y:v.y});
							coords.push({x:v.x2,y:v.y2});
							block_list.push(v.block);
						}
						else if(v.type == "arc"){
							coords.push({x:v.cx+Math.cos(v.start*Math.PI)*v.r,y:v.cy+Math.sin(v.start*Math.PI)*v.r});
							coords.push({x:v.cx+Math.cos(v.end*Math.PI)*v.r,y:v.cy+Math.sin(v.end*Math.PI)*v.r});
							block_list.push(v.block);
						}
						else if(v.type == "swl"){
							coords.push({x:v.x,y:v.y});
							if(v.r == 0.25){
								coords.push({x:v.x+ro[0].x+ds,y:v.y+2*ro[0].y});
								coords.push({x:v.x+ro[0].x,y:v.y+ro[0].y});
							}else if(v.r == -0.25){
								coords.push({x:v.x+ro[0].x+ds,y:v.y-2*ro[0].y});
								coords.push({x:v.x+ro[0].y,y:v.y-ro[0].x});
							}
							else if(v.r == 0){
								coords.push({x:v.x+ro[0].x,y:v.y});
								coords.push({x:v.x+ro[0].x,y:v.y-ro[0].y});
							}
							else if(v.r == 1 || v.r == -1){
								coords.push({x:v.x-ro[0].x,y:v.y});
								coords.push({x:v.x-ro[0].x,y:v.y+ro[0].y});
							}
							block_list.push(v.block);
							switch_list.push(v.switch);
						}
						else if(v.type == "swr"){
							coords.push({x:v.x,y:v.y});
							if(v.r == 0.25){
								coords.push({x:v.x+ro[0].x+ds,y:v.y+2*ro[0].y});
								coords.push({x:v.x+ro[0].y,y:v.y+ro[0].x});
							}else if(v.r == -0.25){
								coords.push({x:v.x+ro[0].x+ds,y:v.y-2*ro[0].y});
								coords.push({x:v.x+ro[0].y,y:v.y-ro[0].x});
							}
							else if(v.r == 0){
								coords.push({x:v.x+ro[0].x,y:v.y});
								coords.push({x:v.x+ro[0].x,y:v.y+ro[0].y});
							}
							else if(v.r == -1 || v.r == 1){
								coords.push({x:v.x-ro[0].x,y:v.y});
								coords.push({x:v.x-ro[0].x,y:v.y-ro[0].y});
							}
							block_list.push(v.block);
							switch_list.push(v.switch);
						}
						else if(v.type == "ds"){
							if(v.xtl != undefined && v.ytl != undefined){
								coords.push({x:v.xtl,y:v.ytl});
								coords.push({x:v.xtl+ds,y:v.ytl+ro[0].y});
								coords.push({x:v.xtl+ro[0].x,y:v.ytl+ro[0].y});
								coords.push({x:v.xtl+ro[0].x+ds,y:v.ytl+2*ro[0].y});
							}else{
								coords.push({x:v.xtr,y:v.ytr});
								coords.push({x:v.xtr-ds,y:v.ytr+ro[0].y});
								coords.push({x:v.xtr-ro[0].x,y:v.ytr+ro[0].y});
								coords.push({x:v.xtr-ro[0].x-ds,y:v.ytr+2*ro[0].y});
							}
							block_list.push(v.block);
							switch_list.push(v.switchA);
							switch_list.push(v.switchB);
						}
						else if(v.type == "dc"){
							block_list.push(v.blockA);
							block_list.push(v.blockB);

							coords.push({x:v.xtl,y:v.ytl});
							coords.push({x:v.xtl+ro[0].x,y:v.ytl});
							coords.push({x:v.xtl+2*ro[0].x,y:v.ytl});
							coords.push({x:v.xtl+ro[0].x,y:v.ytl+ro[0].y});
							coords.push({x:v.xtl,y:v.ytl+2*ro[0].y});
							coords.push({x:v.xtl+ro[0].x,y:v.ytl+2*ro[0].y});
							coords.push({x:v.xtl+2*ro[0].x,y:v.ytl+2*ro[0].y});

							switch_list.push(v.switchA);
							switch_list.push(v.switchB);
							switch_list.push(v.switchC);
							switch_list.push(v.switchD);
						}

						$.each(coords,function(i,v){
							for(var j = 0;j<=module_v.dotmatrix.length;j++){
								if(j == module_v.dotmatrix.length){
									module_v.dotmatrix.push({x:v.x,y:v.y,blocks:block_list});
									break;
								}
								if(Math.pow(v.x - module_v.dotmatrix[j].x,2)+Math.pow(v.y - module_v.dotmatrix[j].y,2) < 4){
									module_v.dotmatrix[j].blocks = module_v.dotmatrix[j].blocks.concat(block_list);
									break;
								}
							}
						});

						if(Math.max(...block_list) > module_v.blocks.length-1){
							for(0;(Math.max(...block_list) - module_v.blocks.length) > -1;0){
								module_v.blocks.push(10);
							}
						}

						if(Math.max(...switch_list) > module_v.switches.length-1){
							for(0;(Math.max(...switch_list) - module_v.switches.length) > -1;0){
								module_v.switches.push(1);
							}
						}
					});
				});
			},
			draw_dotmatrix: function(){
				c.lineWidth = 0.1;
				//Draw dots
				var dot_radius = Math.min(2.8*this.dimensions.scale,2.8);
				var tmp_this = this;
				$.each(modules,function(module,module_v){
					if (module_v.visible == false){
						return true;
					}
					var ofX = module_v.OffsetX + tmp_this.dimensions.ofX;
					var ofY = module_v.OffsetY + tmp_this.dimensions.ofY;
					var rvX = Math.cos(module_v.r*Math.PI);
					var rvX_ = Math.cos((module_v.r+0.5)*Math.PI);
					var rvY = Math.sin((module_v.r+0.5)*Math.PI);
					var rvY_ = Math.sin((module_v.r)*Math.PI);
					$.each(module_v.dotmatrix,function(i,v){
						c.beginPath();
						var block_state = 255;
						$.each(v.blocks,function(i2,v2){
							if(module_v.blocks[v2] < block_state){
								block_state = module_v.blocks[v2];
							}
						});
						c.arc(ofX+rvX*v.x+rvY_*v.y,ofY+rvY*v.y+rvX_*v.x,dot_radius,0,2*Math.PI,false);
						tmp_this.setStrokeColor(block_state,0);
						c.fillStyle = c.strokeStyle;
						c.fill();
						c.stroke();
					});
				});
			},

			draw_background: function(){
				c.lineWidth = 6;
				var tmp_this = this;
				//Draw background lines
				$.each(modules,function(module,module_v){
					if (module_v.visible == false){
						return true;
					}
					var ofX = module_v.OffsetX + tmp_this.dimensions.ofX;
					var ofY = module_v.OffsetY + tmp_this.dimensions.ofY;
					var rvX = Math.cos(module_v.r*Math.PI);
					var rvX_ = Math.cos((module_v.r+0.5)*Math.PI);
					var rvY = Math.sin((module_v.r+0.5)*Math.PI);
					var rvY_ = Math.sin((module_v.r)*Math.PI);
					$.each(module_v.data,function(i,v){
						c.beginPath();
						c.strokeStyle = v.stroke;

						if(v.type == "ds"){
							test = 13;
						}

						if(v.type == "arc"){

						}else{
							nx = rvX*v.x + rvY_*v.y + ofX;
							ny = rvY*v.y + rvX_*v.x + ofY;
						}
						nr = v.r - module_v.r;

						if(v.type == "swr" || v.type == "swl"){ // Switch Right
							if(v.if != undefined){
								var j = 0;
								for (var i = v.if.length - 1; i >= 0; i--) {
									if(module_v.switches[v.if[i].sw] != v.if[i].st){
										j++;
									}
								}
								if(j != v.if.length){
									Draw.switch(nx, ny, nr, v.type, "B",module_v.blocks[v.block],module_v.switches[v.switch]);
									c.stroke();
									return true
								}
								Draw.switch(nx, ny, nr, v.type, "G",module_v.blocks[v.block],module_v.switches[v.switch]);
							}
							else{
								Draw.switch(nx, ny, nr, v.type, "B",module_v.blocks[v.block],module_v.switches[v.switch]);
							}
						}
						else if(v.type == "ds"){ //Double slip
							Draw.double_slip(nx, ny, nr, "B",module_v.blocks[v.block],module_v.switches[v.switchA], module_v.switches[v.switchB]);
						}
						else if(v.type == "dsf"){ //Double slip flipped
							Draw.double_slip_mirrored(nx, ny, nr, "B",module_v.blocks[v.block],module_v.switches[v.switchA], module_v.switches[v.switchB]);
						}
						else if(v.type == "dc"){ //Double crossover
							if(v.xtl != undefined && v.ytl != undefined){
								tmp_this.setStrokeColor(module_v.blocks[v.blockA],1);
								if(module_v.switches[v.switchA] == 1 || module_v.switches[v.switchB] == 1){
									c.moveTo(v.xtl+ofX,v.ytl+ofY);
									c.lineTo(v.xtl+ofX+1*ro[0].x,v.ytl+ofY);
									c.stroke();c.beginPath();
									c.moveTo(v.xtl+ofX+1*ro[0].x,v.ytl+ofY);
									c.lineTo(v.xtl+ofX+2*ro[0].x,v.ytl+ofY);
									c.stroke();c.beginPath();
								}
								if(module_v.switches[v.switchA] == 0){
									c.arc(v.xtl+ofX,v.ytl+ofY+radia[0],radia[0],Math.PI*-0.5+0.05,Math.PI*-0.25,false);
									c.stroke();c.beginPath();
								}

								if(module_v.switches[v.switchB] == 0){
									c.arc(v.xtl+ofX+2*ro[0].x,v.ytl+ofY+radia[0],radia[0],Math.PI*-0.5-0.05,Math.PI*-0.75,true);
									c.stroke();c.beginPath();
								}

								tmp_this.setStrokeColor(module_v.blocks[v.blockB],1);
								if(module_v.switches[v.switchC] == 1 || module_v.switches[v.switchD] == 1){
									c.moveTo(v.xtl+ofX,v.ytl+ofY+2*ro[0].y);
									c.lineTo(v.xtl+ofX+1*ro[0].x,v.ytl+ofY+2*ro[0].y);
									c.stroke();c.beginPath();
									c.moveTo(v.xtl+ofX+1*ro[0].x,v.ytl+ofY+2*ro[0].y);
									c.lineTo(v.xtl+ofX+2*ro[0].x,v.ytl+ofY+2*ro[0].y);
									c.stroke();c.beginPath();
								}
								if(module_v.switches[v.switchC] == 0){
									c.arc(v.xtl+ofX,v.ytl+ofY+2*ro[0].y-radia[0],radia[0],Math.PI*0.5-0.05,Math.PI*0.25,true);
									c.stroke();c.beginPath();
								}

								if(module_v.switches[v.switchD] == 0){
									c.arc(v.xtl+ofX+2*ro[0].x,v.ytl+ofY+2*ro[0].y-radia[0],radia[0],Math.PI*0.5+0.05,Math.PI*0.75,false);
									c.stroke();c.beginPath();
								}

							}
						}
						c.stroke();
					});
				});
			},

			draw_foreground: function(){
				var tmp_this = this;
				//Draw lines
				c.lineWidth = 6;
				$.each(modules,function(module,module_v){
					if (module_v.visible == false){
						return true;
					}
					var ofX = module_v.OffsetX + tmp_this.dimensions.ofX;
					var ofY = module_v.OffsetY + tmp_this.dimensions.ofY;
					var rvX = Math.cos(module_v.r*Math.PI);
					var rvX_ = Math.cos((module_v.r+0.5)*Math.PI);
					var rvY = Math.sin((module_v.r+0.5)*Math.PI);
					var rvY_ = Math.sin((module_v.r)*Math.PI);
					$.each(module_v.data,function(i,v){
						c.beginPath();
						c.strokeStyle = v.stroke;

						if(v.type == "ds"){
							test = 13;
						}

						if(v.type == "arc"){

						}else{
							nx = rvX*v.x + rvY_*v.y + ofX;
							ny = rvY*v.y + rvX_*v.x + ofY;
						}
						nr = v.r - module_v.r

						if(v.type == "line"){
							tmp_this.setStrokeColor(module_v.blocks[v.block]);
							c.moveTo(nx, ny);
							c.lineTo(rvX*v.x2+rvY_*v.y2+ofX,rvY*v.y2+rvX_*v.x2+ofY);
						}
						else if(v.type == "arc"){
							tmp_this.setStrokeColor(module_v.blocks[v.block]);
							c.arc(rvX*v.cx+rvY_*v.cy+ofX,rvY*v.cy+rvX_*v.cx+ofY,v.r,Math.PI*(-module_v.r+v.start),Math.PI*(-module_v.r+v.end),v.CW);
						}
						else if(v.type == "swr" || v.type == "swl"){ // Switch Right
							if(v.if != undefined){
								where = "F";
								for (var i = v.if.length - 1; i >= 0; i--) {
									if(module_v.switches[v.if[i].sw] != v.if[i].st)
										return true;
								}
							}
							Draw.switch(nx, ny, nr, v.type, "F",module_v.blocks[v.block],module_v.switches[v.switch]);
						}
						else if(v.type == "ds"){ //Double slip
							Draw.double_slip(nx, ny, nr, "F",module_v.blocks[v.block],module_v.switches[v.switchA], module_v.switches[v.switchB]);
						}
						else if(v.type == "dsf"){ //Double slip flipped
							Draw.double_slip_mirrored(nx, ny, nr, "F",module_v.blocks[v.block],module_v.switches[v.switchA], module_v.switches[v.switchB]);
						}
						else if(v.type == "dc"){
							if(v.xtl != undefined && v.ytl != undefined){
								tmp_this.setStrokeColor(module_v.blocks[v.blockA],0);
								if(module_v.switches[v.switchA] == 0 && module_v.switches[v.switchB] == 0){
									c.moveTo(v.xtl+ofX,v.ytl+ofY);
									c.lineTo(v.xtl+ofX+1*ro[0].x,v.ytl+ofY);
									c.stroke();c.beginPath();
									c.moveTo(v.xtl+ofX+1*ro[0].x,v.ytl+ofY);
									c.lineTo(v.xtl+ofX+2*ro[0].x,v.ytl+ofY);
									c.stroke();c.beginPath();
								}
								else{
									if(module_v.switches[v.switchA] == 1){
										c.arc(v.xtl+ofX,v.ytl+ofY+radia[0],radia[0],Math.PI*-0.5,Math.PI*-0.25,false);
										c.stroke();c.beginPath();
									}

									if(module_v.switches[v.switchB] == 1){
										c.arc(v.xtl+ofX+2*ro[0].x,v.ytl+ofY+radia[0],radia[0],Math.PI*-0.5,Math.PI*-0.75,true);
										c.stroke();c.beginPath();
									}
								}

								tmp_this.setStrokeColor(module_v.blocks[v.blockB],0);
								if(module_v.switches[v.switchC] == 0 && module_v.switches[v.switchD] == 0){
									c.moveTo(v.xtl+ofX,v.ytl+ofY+2*ro[0].y);
									c.lineTo(v.xtl+ofX+1*ro[0].x,v.ytl+ofY+2*ro[0].y);
									c.stroke();c.beginPath();
									c.moveTo(v.xtl+ofX+1*ro[0].x,v.ytl+ofY+2*ro[0].y);
									c.lineTo(v.xtl+ofX+2*ro[0].x,v.ytl+ofY+2*ro[0].y);
									c.stroke();c.beginPath();
								}
								else{
									if(module_v.switches[v.switchC] == 1){
										c.arc(v.xtl+ofX,v.ytl+ofY+2*ro[0].y-radia[0],radia[0],Math.PI*0.5,Math.PI*0.25,true);
										c.stroke();c.beginPath();
									}

									if(module_v.switches[v.switchD] == 1){
										c.arc(v.xtl+ofX+2*ro[0].x,v.ytl+ofY+2*ro[0].y-radia[0],radia[0],Math.PI*0.5,Math.PI*0.75,false);
										c.stroke();c.beginPath();
									}
								}

							}
						}
						c.stroke();
					});
				});
			},

			setStrokeColor: function(b, s = 0){
				if(b == 0){ // Blocked
					(s == 0)?this.c.strokeStyle = "#900":this.c.strokeStyle = "#daa";
			   	}
			   	else if(b == 1){ // DANGER
			    	(s == 0)?this.c.strokeStyle = "#f00":this.c.strokeStyle = "#f66";
			    }
			   	else if(b == 2){ // RESTRICTED
			    	(s == 0)?this.c.strokeStyle = "#f40":this.c.strokeStyle = "#f76";
			    }
			    else if(b == 3){ // CAUTION
			    	(s == 0)?this.c.strokeStyle = "#f70":this.c.strokeStyle = "#fd6";
			    }
			    else if(b == 4){ // PROCEED
			    	(s == 0)?this.c.strokeStyle = "#aaa":this.c.strokeStyle = "#ddd";
			    }
			    else if(b == 5){ // RESERVED
			    	(s == 0)?this.c.strokeStyle = "#66f":this.c.strokeStyle = "#99f";
			    }
			    else if(b == 6){ // RESERVED_SWICTH
			    	(s == 0)?this.c.strokeStyle = "#00f":this.c.strokeStyle = "#66f";
			    }
			    else{ //Unknown
			    	(s == 0)?this.c.strokeStyle = "#ddd":this.c.strokeStyle = "#eee";
			    }
			},

		    update_frame: function(){
				console.log("Update Frame\n\tClear\t"+this.dimensions.width/this.dimensions.scale+"\t",this.dimensions.height/this.dimensions.scale);
				c.clearRect(0, 0, this.dimensions.width/this.dimensions.scale, this.dimensions.height/this.dimensions.scale);
				var tmp_this = this;

				this.draw_background();
				this.draw_dotmatrix();
				this.draw_foreground();

				

				//Draw Tooltips
				$.each(modules,function(module,module_v){
					if (module_v.visible == false){
						return true;
					}
					var ofX = module_v.OffsetX + tmp_this.dimensions.ofX;
					var ofY = module_v.OffsetY + tmp_this.dimensions.ofY;
					var rvX = Math.cos(module_v.r*Math.PI);
					var rvX_ = Math.cos((module_v.r+0.5)*Math.PI);
					var rvY = Math.sin((module_v.r+0.5)*Math.PI);
					var rvY_ = Math.sin((module_v.r)*Math.PI);
					c.beginPath();
					c.moveTo(ofX,ofY);
					c.lineTo(rvX*module_v.width+ofX,rvX_*module_v.width+ofY);
					c.lineTo(rvX*module_v.width+rvY_*module_v.height+ofX,rvY*module_v.height+rvX_*module_v.width+ofY);
					c.lineTo(rvY_*module_v.height+ofX,rvY*module_v.height+ofY);
					c.lineTo(ofX,ofY);
					c.lineWidth = 0.5;
					c.strokeStyle = "#000";
					c.stroke();
					// $.each(module_v.data,function(i,v){
					// 	if(v.tooltip){
					// 		if(v.type == "dc"){
					// 			c.lineWidth = 1;
					// 			c.beginPath();
					// 			c.rect(v.xtl+ofX,v.ytl+ofY+3*ro[0].y,2*ro[0].x,(1.6+0.5+0.5+2.5)*ro[0].y);
					// 			c.strokeStyle = "#000";
					// 			c.fillStyle = "#fff";
					// 			c.fill();
					// 			c.stroke(); 

					// 			var mid = v.xtl+ofX+ro[0].x;

					// 			c.strokeStyle = "#ddd";
					// 			// c.lineWidth = 0.5;
					// 			c.beginPath();
					// 			c.moveTo(mid-ro[0].x,v.ytl+ofY+(3+1.75)*ro[0].y);
					// 			c.lineTo(mid+ro[0].x,v.ytl+ofY+(3+1.75)*ro[0].y);
					// 			c.stroke();c.beginPath();
					// 			c.moveTo(mid-ro[0].x,v.ytl+ofY+(3+3.25)*ro[0].y);
					// 			c.lineTo(mid+ro[0].x,v.ytl+ofY+(3+3.25)*ro[0].y);
					// 			c.stroke();
					// 			var y_top = v.ytl+ofY+3.5*ro[0].y;
					// 			//Write all options
					// 			//A
					// 			c.strokeStyle = "#ddd";
					// 			c.lineWidth = 0.5*6;
					// 			c.beginPath();
					// 			c.arc(mid-0.5*ro[0].x,y_top+0.5*radia[0],0.5*radia[0],Math.PI*-0.5,Math.PI*-0.25,false);
					// 			c.stroke();c.beginPath();
					// 			c.arc(mid+0.5*ro[0].x,y_top+0.5*radia[0],0.5*radia[0],Math.PI*-0.5,Math.PI*-0.75,true);
					// 			c.stroke();c.beginPath();
					// 			c.arc(mid-0.5*ro[0].x,y_top+ro[0].y-0.5*radia[0],0.5*radia[0],Math.PI*0.5,Math.PI*0.25,true);
					// 			c.stroke();c.beginPath();
					// 			c.arc(mid+0.5*ro[0].x,y_top+ro[0].y-0.5*radia[0],0.5*radia[0],Math.PI*0.5,Math.PI*0.75,false);
					// 			c.stroke();c.beginPath();
					// 			c.strokeStyle = "#aaa";
					// 			c.moveTo(mid-0.5*ro[0].x,y_top);
					// 			c.lineTo(mid+0.5*ro[0].x,y_top);
					// 			c.stroke();
					// 			c.beginPath();
					// 			c.moveTo(mid-0.5*ro[0].x,y_top+ro[0].y);
					// 			c.lineTo(mid+0.5*ro[0].x,y_top+ro[0].y);
					// 			c.stroke();
					// 			//B
					// 			y_top += 1.5*ro[0].y;

					// 			c.strokeStyle = "#ddd";
					// 			c.lineWidth = 0.5*6;
					// 			c.beginPath();
					// 			c.arc(mid+0.5*ro[0].x,y_top+0.5*radia[0],0.5*radia[0],Math.PI*-0.5,Math.PI*-0.75,true);
					// 			c.stroke();c.beginPath();
					// 			c.arc(mid-0.5*ro[0].x,y_top+ro[0].y-0.5*radia[0],0.5*radia[0],Math.PI*0.5,Math.PI*0.25,true);
					// 			c.stroke();c.beginPath();
					// 			c.moveTo(mid-0.5*ro[0].x,y_top);
					// 			c.lineTo(mid+0.5*ro[0].x,y_top);
					// 			c.stroke();
					// 			c.beginPath();
					// 			c.moveTo(mid-0.5*ro[0].x,y_top+ro[0].y);
					// 			c.lineTo(mid+0.5*ro[0].x,y_top+ro[0].y);
					// 			c.stroke();c.beginPath();
					// 			c.strokeStyle = "#aaa";
					// 			c.arc(mid+0.5*ro[0].x,y_top+ro[0].y-0.5*radia[0],0.5*radia[0],Math.PI*0.5,Math.PI*0.75,false);
					// 			c.stroke();c.beginPath();
					// 			c.arc(mid-0.5*ro[0].x,y_top+0.5*radia[0],0.5*radia[0],Math.PI*-0.5,Math.PI*-0.25,false);
					// 			c.stroke();c.beginPath();
					// 			//C
					// 			y_top += 1.5*ro[0].y;

					// 			c.strokeStyle = "#ddd";
					// 			c.lineWidth = 0.5*6;
					// 			c.beginPath();
					// 			c.arc(mid+0.5*ro[0].x,y_top+ro[0].y-0.5*radia[0],0.5*radia[0],Math.PI*0.5,Math.PI*0.75,false);
					// 			c.stroke();c.beginPath();
					// 			c.arc(mid-0.5*ro[0].x,y_top+0.5*radia[0],0.5*radia[0],Math.PI*-0.5,Math.PI*-0.25,false);
					// 			c.stroke();c.beginPath();
					// 			c.moveTo(mid-0.5*ro[0].x,y_top);
					// 			c.lineTo(mid+0.5*ro[0].x,y_top);
					// 			c.stroke();
					// 			c.beginPath();
					// 			c.moveTo(mid-0.5*ro[0].x,y_top+ro[0].y);
					// 			c.lineTo(mid+0.5*ro[0].x,y_top+ro[0].y);
					// 			c.stroke();c.beginPath();
					// 			c.strokeStyle = "#aaa";
					// 			c.arc(mid+0.5*ro[0].x,y_top+0.5*radia[0],0.5*radia[0],Math.PI*-0.5,Math.PI*-0.75,true);
					// 			c.stroke();c.beginPath();
					// 			c.arc(mid-0.5*ro[0].x,y_top+ro[0].y-0.5*radia[0],0.5*radia[0],Math.PI*0.5,Math.PI*0.25,true);
					// 			c.stroke();c.beginPath();
					// 		}
					// 	}
					// });
				});
		    },

		    // Events //
		    // Control functions

			click: function(x,y){
				var update = false;
				var tmp_this = this;
				$.each(modules,function(module,module_v){
					var ofX = module_v.OffsetX;
					var ofY = module_v.OffsetY;
					var rvX = Math.cos(module_v.r*Math.PI);
					var rvX_ = Math.cos((module_v.r+0.5)*Math.PI);
					var rvY = Math.sin((module_v.r+0.5)*Math.PI);
					var rvY_ = Math.sin((module_v.r)*Math.PI);
					_x = x/tmp_this.dimensions.scale - ofX - tmp_this.dimensions.ofX;
					_y = y/tmp_this.dimensions.scale - ofY - tmp_this.dimensions.ofY;
					_l = Math.sqrt(Math.pow(_x,2)+Math.pow(_y,2));
					_r = Math.atan(_y/_x);
					(_x<0&&_y<0)?_r=-(Math.PI-_r):1;
					_r -= module_v.r*Math.PI;
					_x = _l*Math.cos(_r);
					_y = _l*Math.sin(_r);
					console.log(_x,_y);
					$.each(module_v.hitboxes,function(i,box){
						if(eval(box.eval_code) == 1){
							console.log("Clicked something");
							if(box.action == "tSw"){ // Throw switch
								throw_Switch(module,box.switch);
							}
							else if(box.action == "tDS"){
								throw_doubleSlib(module,box.switch);
							}
							else if(box.action == "tDC"){
								throw_doubleCrossover(module,box.switch);
							}
							else{
								alert("Hit " + box.name + "\n with no action");
							}
							update = true
						}
					});
				});
				if(update)
					this.update_frame();
			},

			moved: function(){
				console.log("Moved");
				if(this.dimensions.width < this.dimensions.content_width){
					//Scroll limiter
					if((this.dimensions.x_left) > -this.dimensions.ofX){
						this.dimensions.ofX = -this.dimensions.x_left;
					}
					if((this.dimensions.x_right) < -this.dimensions.ofX+this.canvas.width / this.dimensions.scale){
						this.dimensions.ofX = -(this.dimensions.x_right - this.canvas.width / this.dimensions.scale);
					}
				}
				if(this.dimensions.height < this.dimensions.content_height){
					//Scroll limiter
					if((this.dimensions.y_top) > -this.dimensions.ofY){
						this.dimensions.ofY = this.dimensions.y_top;
					}
					if((this.dimensions.y_bottom) < -this.dimensions.ofY+this.canvas.height / this.dimensions.scale){
						this.dimensions.ofY = -(this.dimensions.y_bottom - this.canvas.height / this.dimensions.scale);
					}
				}

				this.update_frame();
			},

			longClick: function(evt){
				alert("Long Click");
				Longclick = true;
			},

			// Events //

			LongclickTimer: undefined,
			Longclick: false,

			evt_mousedown: function(evt){
				Canvas.Longclick = false;
				Canvas.LongclickTimer = setTimeout(function(){Canvas.longClick(evt)},400);
				Train.hide(evt);
			},
			evt_mouseup: function(evt){
				clearTimeout(Canvas.LongclickTimer);
				if(!Canvas.touchClicked && !Canvas.Longclick)
					Canvas.click(evt.offsetX,evt.offsetY);
				else
					Canvas.touchClicked = false;
			},


			touchStart: {x:0,y:0},
			touchMove: {x:0,y:0},
			touchMoved: false,
			touchClicked: false,
			evt_drag_start: function(evt){
				Canvas.touchStart.x = (Canvas.touchMove.x = evt.touches[0].pageX);
				Canvas.touchStart.y = (Canvas.touchMove.y = evt.touches[0].pageY);
				Canvas.touchMoved = false;

				Canvas.LongclickTimer = setTimeout(function(){longClick(evt)},600);

				Train.hide(evt);
			},
			evt_drag_move: function(evt){
				if(Canvas.touchMoved == true){
					if(Canvas.dimensions.width < Canvas.dimensions.content_width){
						Canvas.dimensions.ofX += (evt.touches[0].pageX - Canvas.touchMove.x)/Canvas.dimensions.scale;
					}
					if(Canvas.dimensions.height < Canvas.dimensions.content_height){
						Canvas.dimensions.ofY += (evt.touches[0].pageY - Canvas.touchMove.y)/Canvas.dimensions.scale;
					}

					Canvas.moved()

					Canvas.touchMove.x = evt.touches[0].pageX;
					Canvas.touchMove.y = evt.touches[0].pageY;

					return false;
				}else{
					if(Math.sqrt(Math.pow(Canvas.touchStart.x - evt.touches[0].pageX,2)+Math.pow(Canvas.touchStart.y - evt.touches[0].pageY,2)) >= 10){
						Canvas.touchMoved = true;
						clearTimeout(Canvas.LongclickTimer);
						console.log("Touch Moved");
					}
				}
			},
			evt_drag_end: function(evt){
				if(Canvas.touchMoved == false){
					Canvas.touchClicked = true;
					Canvas.click(Canvas.touchStart.x,Canvas.touchStart.y);
					clearTimeout(Canvas.LongclickTimer);
				}

				evt.preventDefault();
				return false;
			},

			evt_scrolled: function(evt){
				console.log("Scroll");

				if(Canvas.dimensions.width < Canvas.dimensions.content_width){
					Canvas.dimensions.ofX -= evt.originalEvent.deltaX/10;
				}
				if(Canvas.dimensions.height < Canvas.dimensions.content_height){
					Canvas.dimensions.ofY -= evt.originalEvent.deltaY/10;
				}

				Canvas.moved();
			}
		}

		Canvas.init_calc();
		ro = Canvas.ro;
		ds = Canvas.ds;
		radia = Canvas.radia;

		var modules = {
			20:{Name: "Straight",visible: true, OffsetX:250,OffsetY:20,width:800,height:160,r:0,blocks:[5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5],switches:[],dotmatrix:[],
				data:[
					{type:"line",block:0, x:0,y:20,          x2:5,y2:20},
					{type:"swr" ,block:0, x:5,y:20,          x2:5,y2:20,r:0,switch:0},
					{type:"line",block:6, x:0,y:20+2*ro[0].y,x2:5+ro[0].x+ds,y2:20+2*ro[0].y},

					{type:"ds"  ,block:6, x:5+ro[0].x,y:20+ro[0].y,r:0,switchA:1,switchB:2},

					{type:"swl" ,block:6, x:5+ds+2*ro[0].x,y:20+3*ro[0].y,switch:3,r:0.25,if:[{sw:2,st:1}]},
					{type:"arc" ,block:6,cx:5+2*ds+4*ro[0].x,cy:20+6*ro[0].y-radia[0],r:radia[0],start:0.75,end:0.5,CW:true},

					{type:"line",block:1,   x:5+ro[0].x,y:20,x2:250,y2:20},
					{type:"line",block:7,   x:5+2*ro[0].x,y:20+2*ro[0].y,x2:250,y2:20+2*ro[0].y},
					
					{type:"line",block:2,   x:250,y:20,                       x2:400,y2:20},
					{type:"line",block:8,   x:250,y:20+2*ro[0].y,             x2:400,y2:20+2*ro[0].y},
					{type:"line",block:12,  x:5+3*ro[0].x+ds  ,y:20+4*ro[0].y,x2:400,y2:20+4*ro[0].y},
					{type:"line",block:15,  x:5+4*ro[0].x+2*ds,y:20+6*ro[0].y,x2:400,y2:20+6*ro[0].y},

					{type:"line",block:3,   x:400,y:20,          x2:550,y2:20},
					{type:"line",block:9,   x:400,y:20+2*ro[0].y,x2:550,y2:20+2*ro[0].y},
					{type:"line",block:13,  x:400,y:20+4*ro[0].y,x2:550,y2:20+4*ro[0].y},
					{type:"line",block:16,  x:400,y:20+6*ro[0].y,x2:550,y2:20+6*ro[0].y},

					{type:"line",block:4,   x:550,y:20,x2:795-ro[0].x,y2:20},
					{type:"line",block:10,  x:550,y:20+2*ro[0].y,x2:795-2*ro[0].x,y2:20+2*ro[0].y},
					{type:"line",block:14,  x:550,y:20+4*ro[0].y,x2:795-3*ro[0].x-ds,y2:20+4*ro[0].y},
					{type:"arc" ,block:14,  cx:795-3*ro[0].x-ds,cy:20+4*ro[0].y-radia[0],r:radia[0],start:0.5,end:0.25,CW:true},
					{type:"line",block:17,  x:550,y:20+6*ro[0].y,x2:800-3*ro[0].x-ds,y2:20+6*ro[0].y},
					{type:"line",block:18,  x:800-3*ro[0].x-ds,y:20+6*ro[0].y,x2:700,y2:20+6*ro[0].y},


					{type:"swl" ,block:5,  x:795,y:20,r:1,switch:6},
					{type:"line",block:5,  x:800,y:20,x2:795,y2:20},
					{type:"line",block:11, x:800,y:20+2*ro[0].y,x2:795-ro[0].x-ds,y2:20+2*ro[0].y},

					{type:"dsf"  ,block:11, x:795-ro[0].x,y:20+ro[0].y,r:0,switchA:5,switchB:4},
				],
				hitboxes:[
					{eval_code:"(_x > 2.5 && _x < 52.5 && _y > 15 && _y < 40)?1:0;",name:"Switch 1",action:"tSw",switch:0},
					{eval_code:"(_x > 42.5 && _x < 97.5 && _y > 40 && _y < 80)?1:0;",name:"Switch 2&3",action:"tDS",switch:[1,2]},
					{eval_code:"(_x > 90 && _x < 150 && _y > 80 && _y < 120)?1:0;",name:"Switch 4",action:"tSw",switch:3},
					{eval_code:"(_x > 702.5 && _x < 757.5 && _y > 40 && _y < 80)?1:0;",name:"Switch 5&6",action:"tDS",switch:[4,5]},
					{eval_code:"(_x > 748.5 && _x < 797.5 && _y > 15 && _y < 40)?1:0;",name:"Switch 6",action:"tSw",switch:6},
				]
			},
			21:{Name: "Straight",visible: true, OffsetX:1050,OffsetY:460,width:800,height:160,r:1,blocks:[5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5],switches:[],dotmatrix:[],
				data:[
				{type:"line",block:0,   x:0,y:20,          x2:200,y2:20},
				{type:"line",block:1,   x:200,y:20,        x2:400,y2:20},
				{type:"line",block:2,   x:400,y:20,        x2:600,y2:20},
				{type:"line",block:3,   x:600,y:20,        x2:800,y2:20},

				{type:"line",block:4,   x:0,y:20+2*ro[0].y,x2:5,y2:20+2*ro[0].y},
				{type:"swr" ,block:4,   x:5,y:20+2*ro[0].y,r:0,switch:0},

				{type:"line",block:5,   x:5+ro[0].x,y:20+2*ro[0].y,x2:200,y2:20+2*ro[0].y},
				{type:"line",block:6,   x:200,y:20+2*ro[0].y,x2:400,y2:20+2*ro[0].y},
				{type:"line",block:7,   x:400,y:20+2*ro[0].y,x2:600,y2:20+2*ro[0].y},
				{type:"line",block:8,   x:795-ro[0].x,y:20+2*ro[0].y,x2:600,y2:20+2*ro[0].y},

				{type:"swl" ,block:9,   x:795,y:20+2*ro[0].y,r:0,r:-1,switch:1},
				{type:"line",block:9,   x:800,y:20+2*ro[0].y,x2:795,y2:20+2*ro[0].y},
				
				{type:"arc" ,block:10, cx:5+2*ro[0].x,cy:20+4*ro[0].y-radia[0],r:radia[0],start:0.75,end:0.5,CW:true},
				{type:"line",block:10,  x:5+2*ro[0].x,y:20+4*ro[0].y,x2:200,y2:20+4*ro[0].y},
				{type:"line",block:11,  x:200,y:20+4*ro[0].y,x2:400,y2:20+4*ro[0].y},
				{type:"line",block:12,  x:400,y:20+4*ro[0].y,x2:600,y2:20+4*ro[0].y},
				{type:"line",block:13,  x:795-2*ro[0].x,y:20+4*ro[0].y,x2:600,y2:20+4*ro[0].y},
				{type:"arc" ,block:13, cx:795-2*ro[0].x,cy:20+4*ro[0].y-radia[0],r:radia[0],start:0.5,end:0.25,CW:true},
				],hitboxes:[
					{eval_code:"(_x > 2.5 && _x < 52.5 && _y > 45 && _y < 70)?1:0;",name:"Switch 1",action:"tSw",switch:0},
					{eval_code:"(_x > 748.5 && _x < 797.5 && _y > 45 && _y < 70)?1:0;",name:"Switch 2",action:"tSw",switch:1},
				]
			},
			22:{Name: "Bocht",visible: true, OffsetX:1050,OffsetY:20,width:250,height:440,r:0,blocks:[5,5,5,5],switches:[],dotmatrix:[],
				data:[
				{type:"arc",block:0,cx:0,cy:220,r:200,start:-0.5,end:0,CW:false},
				{type:"arc",block:2,cx:0,cy:220,r:200-2*ro[0].y,start:-0.5,end:0,CW:false},
				{type:"arc",block:1,cx:0,cy:220,r:200,start:0,end:0.5,CW:false},
				{type:"arc",block:3,cx:0,cy:220,r:200-2*ro[0].y,start:0,end:0.5,CW:false}
				]
			},
			23:{Name: "Bocht",visible: true, OffsetX:250,OffsetY:460,width:250,height:440,r:1,blocks:[5,5,5,5],switches:[],dotmatrix:[],
				data:[
				{type:"arc",block:0,cx:0,cy:220,r:200,start:-0.5,end:0,CW:false},
				{type:"arc",block:2,cx:0,cy:220,r:200-2*ro[0].y,start:-0.5,end:0,CW:false},
				{type:"arc",block:1,cx:0,cy:220,r:200,start:0,end:0.5,CW:false},
				{type:"arc",block:3,cx:0,cy:220,r:200-2*ro[0].y,start:0,end:0.5,CW:false}
				]
			},
		}

		function reset_blocks_in_modules(){
			$.each(modules, function(i,v){
				console.log(v)
				$.each(v.blocks,function(i2,v2){
					modules[i].blocks[i2] = 10;
				})
			})
		}

		var Draw = {
			switch: function(x,y,r,lr,type,bl,sw){
				if(r >  1){r -= 2;}
				if(r < -1){r += 2;}

				var rvX = Math.cos(r*Math.PI);
				var rvX_ = Math.cos((r+0.5)*Math.PI);
				var rvY = Math.sin((r+0.5)*Math.PI);
				var rvY_ = Math.sin((r)*Math.PI);
				if((sw == 0 && type == "F") || (sw == 1 && type == "B") || type == "G"){
					(type == "F")?Canvas.setStrokeColor(bl,0):Canvas.setStrokeColor(bl,1);
					if(r == 0.25 || r == 0.75 || r == 1.25 || r == 1.75 || r == -0.25 || r == -0.75 || r == -1.25 || r == -1.75){
						c.moveTo(x,y);
						if(r == -0.25 || r == 1.75){
							c.lineTo(x+ro[0].x+ds,y-2*ro[0].y);
						}else if(r == -0.75 || r == 1.25){
							c.lineTo(x-ro[0].x-ds,y-2*ro[0].y);
						}else if(r == -1.25 || r == 0.75){
							c.lineTo(x-ro[0].x-ds,y+2*ro[0].y);
						}else if(r == -1.75 || r == 0.25){
							c.lineTo(x+ro[0].x+ds,y+2*ro[0].y);
						}
					}else if(r == 0 || r == 0.5 || r == 1 || r == 1.5 || r == 2 || r == -0.5 || r == -1 || r == -1.5 || r == -2){
						c.moveTo(x,y);
						c.lineTo(x+rvX*ro[0].x,y+rvY_*ro[0].x);
					}
				}
				if((sw == 1 && type == "F") || (sw == 0 && type == "B") || type == "G"){
					(type == "F")?Canvas.setStrokeColor(bl,0):Canvas.setStrokeColor(bl,1);
					if(lr == "swr"){
						if(r == 0.25 || r == -1.75){
							c.arc(x-rvX*radia[0],y+rvY*radia[0],radia[0],Math.PI*(r-0.25),Math.PI*(r-0.5),true);
						}else if(r == -0.25 || r == 1.75){
							c.arc(x+rvX*radia[0],y+rvY*radia[0],radia[0],Math.PI*(r-0.25),Math.PI*(r-0.5),true);
						}else if(r == 0.75 || r == -1.25){
							c.arc(x+rvX*radia[0],y+rvY*radia[0],radia[0],Math.PI*(r-0.25),Math.PI*(r-0.5),true);
						}else if(r == -0.75 || r == 1.25){
							c.arc(x-rvX*radia[0],y+rvY*radia[0],radia[0],Math.PI*(r-0.25),Math.PI*(r-0.5),true);
						}else if(r == 0){
							c.arc(x,y+radia[0],radia[0],Math.PI*(r-0.25),Math.PI*(r-0.5),true);
						}else if(r == -1 || r == 1){
							c.arc(x,y-radia[0],radia[0],Math.PI*(r-0.25),Math.PI*(r-0.5),true);
						}
						else if(r == -0.5){
							c.arc(x+radia[0],y,radia[0],Math.PI*(r-0.25),Math.PI*(r-0.5),true);
						}
						else if(r == 0.5){
							c.arc(x-radia[0],y,radia[0],Math.PI*(r-0.25),Math.PI*(r-0.5),true);
						}
					}
					else{
						if(r == 0.25 || r == -1.75){
							c.arc(x+rvX*radia[0],y-rvY*radia[0],radia[0],Math.PI*(r+0.5),Math.PI*(r+0.25),true);//
						}else if(r == -0.25 || r == 1.75){
							c.arc(x-rvX*radia[0],y-rvY*radia[0],radia[0],Math.PI*(r+0.5),Math.PI*(r+0.25),true);//
						}else if(r == 0.75 || r == -1.25){
							c.arc(x-rvX*radia[0],y-rvY*radia[0],radia[0],Math.PI*(r+0.5),Math.PI*(r+0.25),true);//
						}else if(r == -0.75 || r == 1.25){
							c.arc(x+rvX*radia[0],y-rvY*radia[0],radia[0],Math.PI*(r+0.5),Math.PI*(r+0.25),true);
						}else if(r == 0){
							c.arc(x,y-radia[0],radia[0],Math.PI*(r+0.5),Math.PI*(r+0.25),true);
						}else if(r == -1 || r == 1){
							c.arc(x,y+radia[0],radia[0],Math.PI*(r+0.5),Math.PI*(r+0.25),true);
						}
						else if(r == -0.5){
							c.arc(x+radia[0],y,radia[0],Math.PI*(r+0.5),Math.PI*(r+0.25),true);
						}
						else if(r == 0.5){
							c.arc(x+radia[0],y,radia[0], Math.PI*(r+0.5), Math.PI*(r+0.25), true)
						}
					}
				}
			},

			double_slip: function(x,y,r,type,bl,swA,swB){
				if(r >  1){r -= 2;}
				if(r < -1){r += 2;}

				var rvX = Math.cos(r*Math.PI);
				var rvX_ = -Math.cos((r+0.5)*Math.PI);
				var rvY = Math.sin((r+0.5)*Math.PI);
				var rvY_ = -Math.sin((r)*Math.PI);

				if((swA == 1 && swB == 0 && type == "F") || ((swA == 0 || swB == 1) && type == "B")){
					(type == "F")?Canvas.setStrokeColor(bl,0):Canvas.setStrokeColor(bl,1);

					if(r == 0.25 || r == -1.75){
						c.arc(x+radia[0],y,radia[0],Math.PI*(r+0.75),Math.PI*(r+0.5),true);//
					}else if(r == -0.25 || r == 1.75){
						c.arc(x,y-radia[0],radia[0],Math.PI*(r+0.750),Math.PI*(r+0.5),true);
					}else if(r == 0.75 || r == -1.25){
						c.arc(x,y+radia[0],radia[0],Math.PI*(r+0.75),Math.PI*(r+0.5),true);//
					}else if(r == -0.75 || r == 1.25){
						c.arc(x-radia[0],y,radia[0],Math.PI*(r+0.75),Math.PI*(r+0.5),true);
					}
					else if(r == 0){
						c.arc(x+ro[0].x,y-radia[0]+ro[0].y,radia[0],Math.PI*(r+0.75),Math.PI*(r+0.50),true);
					}else if(r == -1 || r == 1){
						c.arc(x-ro[0].x,y-ro[0].y+radia[0],radia[0],Math.PI*(r+0.75),Math.PI*(r+0.5),true);
					}else if(r == -0.5){
						c.arc(x-radia[0]+ro[0].y,y-ro[0].x,radia[0],Math.PI*(r+0.75),Math.PI*(r+0.5),true);
					}else if(r == 0.5){
						c.arc(x-ro[0].y+radia[0],y+ro[0].x,radia[0], Math.PI*(r+0.75), Math.PI*(r+0.5), true)
					}

					c.stroke();c.beginPath();
				}
				if((swA == 1 && swB == 1 && type == "F") || ((swA == 0 || swB == 0) && type == "B")){
					(type == "F")?Canvas.setStrokeColor(bl,0):Canvas.setStrokeColor(bl,1);

					dis_X = ro[0].x+ds;
					dis_Y = 2 * ro[0].y;

					if(r == 0.25 || r == 0.75 || r == 1.25 || r == 1.75 || r == -0.25 || r == -0.75 || r == -1.25 || r == -1.75){
						c.moveTo(x,y);
						if(r == -0.25 || r == 1.75){
							c.lineTo(x+ro[0].x-ds,y);
						}else if(r == -0.75 || r == 1.25){
							c.lineTo(x,y-ro[0].x+ds);
						}else if(r == -1.25 || r == 0.75){
							c.lineTo(x-ro[0].x+ds,y);
						}else if(r == -1.75 || r == 0.25){
							c.lineTo(x,y+ro[0].x-ds);
						}
					}else if(r == 0 || r == 0.5 || r == 1 || r == 1.5 || r == 2 || r == -0.5 || r == -1 || r == -1.5 || r == -2){
						c.moveTo(x,y);
						c.lineTo(x+rvX*dis_X+rvY_*dis_Y, y+rvX_*dis_X+rvY*dis_Y);
					}
					c.stroke();c.beginPath();
				}

				if((swA == 0 && swB == 0 && type == "F") || ((swA == 1 || swB == 1) && type == "B")){
					(type == "F")?Canvas.setStrokeColor(bl,0):Canvas.setStrokeColor(bl,1);
					tx = x; ty = y;

					x += rvX*ds + rvY_*ro[0].y;
					y += rvX_*ds + rvY*ro[0].y;
					dis_X = ro[0].x - ds;
					dis_Y = 0;

					if(r == 0.25 || r == 0.75 || r == 1.25 || r == 1.75 || r == -0.25 || r == -0.75 || r == -1.25 || r == -1.75){
						dis_X += -ds;
					}

					c.moveTo(x,y);
					c.lineTo(x+rvX*dis_X+rvY_*dis_Y, y+rvX_*dis_X+rvY*dis_Y);
					c.stroke();c.beginPath();

					x = tx; y = ty;
				}
				if((swA == 0 && swB == 1 && type == "F") || ((swA == 1 || swB == 0) && type == "B")){
					(type == "F")?Canvas.setStrokeColor(bl,0):Canvas.setStrokeColor(bl,1);

					x += rvX*ds + rvY_*ro[0].y;
					y += rvX_*ds + rvY*ro[0].y;

					if(r == 0.25 || r == -1.75){
						c.arc(x-rvX*radia[0],y+rvY*radia[0],radia[0],Math.PI*(r-0.25),Math.PI*(r-0.5),true);
					}else if(r == -0.25 || r == 1.75){
						c.arc(x+rvX*radia[0],y+rvY*radia[0],radia[0],Math.PI*(r-0.25),Math.PI*(r-0.5),true);
					}else if(r == 0.75 || r == -1.25){
						c.arc(x+rvX*radia[0],y+rvY*radia[0],radia[0],Math.PI*(r-0.25),Math.PI*(r-0.5),true);
					}else if(r == -0.75 || r == 1.25){
						c.arc(x-rvX*radia[0],y+rvY*radia[0],radia[0],Math.PI*(r-0.25),Math.PI*(r-0.5),true);
					}
					else if(r == 0){
						c.arc(x,y+radia[0],radia[0],Math.PI*(r-0.25),Math.PI*(r-0.5),true);
					}else if(r == -1 || r == 1){
						c.arc(x,y-radia[0],radia[0],Math.PI*(r-0.25),Math.PI*(r-0.5),true);
					}else if(r == -0.5){
						c.arc(x+radia[0],y,radia[0],Math.PI*(r-0.25),Math.PI*(r-0.5),true);
					}else if(r == 0.5){
						c.arc(x-radia[0],y,radia[0],Math.PI*(r-0.25),Math.PI*(r-0.5),true);
					}

					c.stroke();c.beginPath();
				}
			},

			double_slip_mirrored: function(x,y,r,type,bl,swA,swB){
				if(r >  1){r -= 2;}
				if(r < -1){r += 2;}

				var rvX = Math.cos(r*Math.PI);
				var rvX_ = -Math.cos((r+0.5)*Math.PI);
				var rvY = Math.sin((r+0.5)*Math.PI);
				var rvY_ = -Math.sin((r)*Math.PI);

				if((swA == 1 && swB == 0 && type == "F") || ((swA == 0 || swB == 1) && type == "B")){
					(type == "F")?Canvas.setStrokeColor(bl,0):Canvas.setStrokeColor(bl,1);

					if(r == 0.25 || r == -1.75){
						// c.arc(x+radia[0],y,radia[0],Math.PI*(r+0.75),Math.PI*(r+0.5),true);//
					}else if(r == -0.25 || r == 1.75){
						// c.arc(x,y-radia[0],radia[0],Math.PI*(r+0.750),Math.PI*(r+0.5),true);
					}else if(r == 0.75 || r == -1.25){
						// c.arc(x,y+radia[0],radia[0],Math.PI*(r+0.75),Math.PI*(r+0.5),true);//
					}else if(r == -0.75 || r == 1.25){
						// c.arc(x-radia[0],y,radia[0],Math.PI*(r+0.75),Math.PI*(r+0.5),true);
					}
					else if(r == 0){
						c.arc(x-ro[0].x,y-radia[0]+ro[0].y,radia[0],Math.PI*(r+0.5),Math.PI*(r+0.25),true);
					}else if(r == -1 || r == 1){
						c.arc(x+ro[0].x,y-ro[0].y+radia[0],radia[0],Math.PI*(r+0.5),Math.PI*(r+0.25),true);
					}else if(r == -0.5){
						// c.arc(x-radia[0]+ro[0].y,y-ro[0].x,radia[0],Math.PI*(r+0.75),Math.PI*(r+0.5),true);
					}else if(r == 0.5){
						// c.arc(x-ro[0].y+radia[0],y+ro[0].x,radia[0], Math.PI*(r+0.75), Math.PI*(r+0.5), true)
					}

					c.stroke();c.beginPath();
				}
				if((swA == 1 && swB == 1 && type == "F") || ((swA == 0 || swB == 0) && type == "B")){
					(type == "F")?Canvas.setStrokeColor(bl,0):Canvas.setStrokeColor(bl,1);

					dis_X = -(ro[0].x+ds);
					dis_Y = 2 * ro[0].y;

					if(r == 0.25 || r == 0.75 || r == 1.25 || r == 1.75 || r == -0.25 || r == -0.75 || r == -1.25 || r == -1.75){
						c.moveTo(x,y);
						if(r == -0.25 || r == 1.75){
							c.lineTo(x-ro[0].x-ds,y);
						}else if(r == -0.75 || r == 1.25){
							c.lineTo(x,y-ro[0].x+ds);
						}else if(r == -1.25 || r == 0.75){
							c.lineTo(x+ro[0].x+ds,y);
						}else if(r == -1.75 || r == 0.25){
							c.lineTo(x,y+ro[0].x-ds);
						}
					}else if(r == 0 || r == 0.5 || r == 1 || r == 1.5 || r == 2 || r == -0.5 || r == -1 || r == -1.5 || r == -2){
						c.moveTo(x,y);
						c.lineTo(x+rvX*dis_X+rvY_*dis_Y, y+rvX_*dis_X+rvY*dis_Y);
					}
					c.stroke();c.beginPath();
				}

				if((swA == 0 && swB == 0 && type == "F") || ((swA == 1 || swB == 1) && type == "B")){
					(type == "F")?Canvas.setStrokeColor(bl,0):Canvas.setStrokeColor(bl,1);
					tx = x; ty = y;

					x += -rvX*ds + rvY_*ro[0].y;
					y += -rvX_*ds + rvY*ro[0].y;
					dis_X = -(ro[0].x - ds);
					dis_Y = 0;

					if(r == 0.25 || r == 0.75 || r == 1.25 || r == 1.75 || r == -0.25 || r == -0.75 || r == -1.25 || r == -1.75){
						dis_X += -ds;
					}

					c.moveTo(x,y);
					c.lineTo(x+rvX*dis_X+rvY_*dis_Y, y+rvX_*dis_X+rvY*dis_Y);
					c.stroke();c.beginPath();

					x = tx; y = ty;
				}
				if((swA == 0 && swB == 1 && type == "F") || ((swA == 1 || swB == 0) && type == "B")){
					(type == "F")?Canvas.setStrokeColor(bl,0):Canvas.setStrokeColor(bl,1);

					x += -rvX*ds + rvY_*ro[0].y;
					y += -rvX_*ds + rvY*ro[0].y;

					if(r == 0.25 || r == -1.75){
						// c.arc(x-rvX*radia[0],y+rvY*radia[0],radia[0],Math.PI*(r-0.25),Math.PI*(r-0.5),true);
					}else if(r == -0.25 || r == 1.75){
						// c.arc(x+rvX*radia[0],y+rvY*radia[0],radia[0],Math.PI*(r-0.25),Math.PI*(r-0.5),true);
					}else if(r == 0.75 || r == -1.25){
						// c.arc(x+rvX*radia[0],y+rvY*radia[0],radia[0],Math.PI*(r-0.25),Math.PI*(r-0.5),true);
					}else if(r == -0.75 || r == 1.25){
						// c.arc(x-rvX*radia[0],y+rvY*radia[0],radia[0],Math.PI*(r-0.25),Math.PI*(r-0.5),true);
					}
					else if(r == 0){
						c.arc(x,y+radia[0],radia[0],Math.PI*(r-0.5),Math.PI*(r-0.75),true);
					}else if(r == -1 || r == 1){
						c.arc(x,y-radia[0],radia[0],Math.PI*(r-0.5),Math.PI*(r-0.75),true);
					}else if(r == -0.5){
						// c.arc(x+radia[0],y,radia[0],Math.PI*(r-0.25),Math.PI*(r-0.5),true);
					}else if(r == 0.5){
						// c.arc(x-radia[0],y,radia[0],Math.PI*(r-0.25),Math.PI*(r-0.5),true);
					}

					c.stroke();c.beginPath();
				}
					// if(swB == 0){
					// 	c.moveTo(v.xtl+ofX+ds,v.ytl+ofY+ro[0].y);
					// 	c.lineTo(v.xtl+ofX+ro[0].x,v.ytl+ofY+ro[0].y);
					// 	c.stroke();c.beginPath();
					// }
					// else{
					// 	c.arc(v.xtl+ofX-8.28,v.ytl+ofY+radia[0]+ro[0].y,radia[0],Math.PI*-0.50,Math.PI*-0.25,false);
					// 	c.stroke();c.beginPath();
					// }
				






				// if((sw == 0 && type == "P") || (sw == 1 && type == "B")){
				// 	(type == "P")?Canvas.setStrokeColor(bl,0):Canvas.setStrokeColor(bl,1);
				// 	if(r == 0.25 || r == 0.75 || r == 1.25 || r == 1.75 || r == -0.25 || r == -0.75 || r == -1.25 || r == -1.75){
				// 		c.moveTo(x,y);
				// 		if(r == -0.25 || r == 1.75){
				// 			c.lineTo(x+ro[0].x+ds,y-2*ro[0].y);
				// 		}else if(r == -0.75 || r == 1.25){
				// 			c.lineTo(x-ro[0].x-ds,y-2*ro[0].y);
				// 		}else if(r == -1.25 || r == 0.75){
				// 			c.lineTo(x-ro[0].x-ds,y+2*ro[0].y);
				// 		}else if(r == -1.75 || r == 0.25){
				// 			c.lineTo(x+ro[0].x+ds,y+2*ro[0].y);
				// 		}
				// 	}else if(r == 0 || r == 0.5 || r == 1 || r == 1.5 || r == 2 || r == -0.5 || r == -1 || r == -1.5 || r == -2){
				// 		c.moveTo(x,y);
				// 		c.lineTo(x+rvX*ro[0].x,y+rvY_*ro[0].x);
				// 	}
				// }
				// else{
				// 	(type == "P")?Canvas.setStrokeColor(bl,0):Canvas.setStrokeColor(bl,1);
				// 	if(lr == "swr"){
				// 		if(r == 0.25 || r == -1.75){
				// 			c.arc(x-rvX*radia[0],y+rvY*radia[0],radia[0],Math.PI*(r-0.25),Math.PI*(r-0.5),true);
				// 		}else if(r == -0.25 || r == 1.75){
				// 			c.arc(x+rvX*radia[0],y+rvY*radia[0],radia[0],Math.PI*(r-0.25),Math.PI*(r-0.5),true);
				// 		}else if(r == 0.75 || r == -1.25){
				// 			c.arc(x+rvX*radia[0],y+rvY*radia[0],radia[0],Math.PI*(r-0.25),Math.PI*(r-0.5),true);
				// 		}else if(r == -0.75 || r == 1.25){
				// 			c.arc(x-rvX*radia[0],y+rvY*radia[0],radia[0],Math.PI*(r-0.25),Math.PI*(r-0.5),true);
				// 		}else if(r == 0){
				// 			c.arc(x,y+radia[0],radia[0],Math.PI*(r-0.25),Math.PI*(r-0.5),true);
				// 		}else{
				// 			c.arc(x,y-radia[0],radia[0],Math.PI*(r-0.25),Math.PI*(r-0.5),true);
				// 		}
				// 	}
				// 	else{
				// 		if(r == 0.25 || r == -1.75){
				// 			c.arc(x+rvX*radia[0],y-rvY*radia[0],radia[0],Math.PI*(r+0.5),Math.PI*(r+0.25),true);//
				// 		}else if(r == -0.25 || r == 1.75){
				// 			c.arc(x-rvX*radia[0],y-rvY*radia[0],radia[0],Math.PI*(r+0.5),Math.PI*(r+0.25),true);//
				// 		}else if(r == 0.75 || r == -1.25){
				// 			c.arc(x-rvX*radia[0],y-rvY*radia[0],radia[0],Math.PI*(r+0.5),Math.PI*(r+0.25),true);//
				// 		}else if(r == -0.75 || r == 1.25){
				// 			c.arc(x+rvX*radia[0],y-rvY*radia[0],radia[0],Math.PI*(r+0.5),Math.PI*(r+0.25),true);
				// 		}else if(r == 0){
				// 			c.arc(x,y-radia[0],radia[0],Math.PI*(r+0.5),Math.PI*(r+0.25),true);
				// 		}else if(r == -1 || r == 1){
				// 			c.arc(x,y+radia[0],radia[0],Math.PI*(r+0.5),Math.PI*(r+0.25),true);
				// 		}
				// 	}
				// }
			}
		}


		// if(window.innerWidth < 764 && window.innerWidth/window.innerHeight < 1){
			//Small Portrait window
		// }

		
		var rotate_timeout;
		function rotate(){
			console.log("rotate");
			Menu.resize();
			Canvas.resize();

			setTimeout(function(){
				Canvas.resize();
			}, 100);
		}

		
	    if("onorientationchange" in window){
	    	window.addEventListener("orientationchange", function () {
			    orientationChanged().then(function() {
			     rotate();
			    });
			}, false);
	    }else{
	    	window.addEventListener("resize", function(){
	    		Menu.resize();Canvas.resize()
	    	}, false);
	    }

		
		// window.addEventListener("resize", view.resize, false);

		//Calculate dotmatrix
		
		// Canvas.resize();

		// Wait until innerheight changes, for max 120 frames
		function orientationChanged() {
		  const timeout = 120;
		  return new window.Promise(function(resolve) {
		    const go = (i, height0) => {
		      window.innerHeight != height0 || i >= timeout ?
		        resolve() :
		        window.requestAnimationFrame(() => go(i + 1, height0));
		    };
		    go(0, window.innerHeight);
		  });
		}

		

		function throw_Switch(m,s){
			if(!ws.connected){
				console.error("Throw_switch: Not connected");
				return;
			}

			if(modules[m].switches[s] == 0){
				websocket.cts_set_switch([[m,s,1]]);
			}else{
				websocket.cts_set_switch([[m,s,0]]);
			}
		}

		function throw_doubleSlib(m,sw){
			if(!ws.connected){
				console.error("throw_doubleSlib: Not connected");
				return;
			}
			
			if(modules[m].switches[sw[0]] == 0){
				if(modules[m].switches[sw[1]] == 0){
					websocket.cts_set_switch([[m,sw[0],0],[m,sw[1],1]]);
				}else{
					websocket.cts_set_switch([[m,sw[0],1],[m,sw[1],1]]);
				}
			}else{
				if(modules[m].switches[sw[1]] == 1){
					websocket.cts_set_switch([[m,sw[0],1],[m,sw[1],0]]);
				}else{
					websocket.cts_set_switch([[m,sw[0],0],[m,sw[1],0]]);
				}
			}
		}

		function throw_doubleCrossover(m,sw){
			if(!ws.connected){
				console.error("throw_doubleCrossover: Not connected");
				return;
			}
			
			if(modules[m].switches[sw[0]] == 0 && modules[m].switches[sw[1]] == 0 && modules[m].switches[sw[2]] == 0 && modules[m].switches[sw[3]] == 0){
				websocket.cts_set_switch([[m,sw[0],1],[m,sw[1],0],[m,sw[2],0],[m,sw[3],1]]);
			}
			else if(modules[m].switches[sw[0]] == 1 && modules[m].switches[sw[1]] == 0 && modules[m].switches[sw[2]] == 0 && modules[m].switches[sw[3]] == 1){
				websocket.cts_set_switch([[m,sw[0],0],[m,sw[1],1],[m,sw[2],1],[m,sw[3],0]]);
			}
			else{
				websocket.cts_set_switch([[m,sw[0],0],[m,sw[1],0],[m,sw[2],0],[m,sw[3],0]]);
			}
		}
	</script>

    <script src="./scripts/socket.js">
    </script>
</body>
</html>
