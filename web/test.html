<!DOCTYPE html>
<!DOCTYPE html>
<html>
<head>
 <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=2.0, minimum-scale=1.0, user-scalable=0">
 <meta name="mobile-web-app-capable" content="yes">
	<title>Canvas</title>
    <script src="./scripts/framework/jquery-3.1.1.js"></script>
	<style type="text/css">
		* {
			margin: 0px;
		}
		body,html {
			overflow:hidden;
		}
		canvas {
			display:inline;
		}
	</style>
</head>
<body>
	<canvas></canvas>
	<div style="position: absolute;right: 0px;bottom: 0px;height: 50px;width: 50px;background: red" onClick='window.location.replace("test.html");'></div>
	<script type="text/javascript">

		var radia = [68.2843]
		var ds = -8.28;
		var ro = [{x:radia[0]*Math.cos(Math.PI*0.25),y:radia[0] - radia[0]*Math.sin(Math.PI*0.25),yr:radia[0]*Math.sin(Math.PI*0.25)}];
		ro[0].l = Math.sqrt(Math.pow(ro[0].x-ds,2)+Math.pow(ro[0].y,2));

		var modules = [
			{Name: "Straight",OffsetX:250,OffsetY:20,width:800,height:160,r:0,blocks:[5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5],switches:[],dotmatrix:[],data:[
				{type:"line",block:0,   x:0,y:20,          x2:5,y2:20},
				{type:"swr" ,block:0,   x:5,y:20,          x2:5,y2:20,r:0,switch:0},
				{type:"line",block:6,   x:0,y:20+2*ro[0].y,x2:5+ro[0].x+ds,y2:20+2*ro[0].y},
				{type:"ds"  ,block:6, xtl:5+ro[0].x,ytl:20+ro[0].y,switchA:1,switchB:2},
				{type:"swl" ,block:6,   x:5+ds+2*ro[0].x,y:20+3*ro[0].y,switch:3,r:0.25},
				{type:"arc" ,block:6,  cx:5+2*ds+4*ro[0].x,cy:20+6*ro[0].y-radia[0],r:radia[0],start:0.75,end:0.5,CW:true},

				{type:"line",block:1,   x:5+ro[0].x,y:20,x2:250,y2:20},
				{type:"line",block:7,   x:5+2*ro[0].x,y:20+2*ro[0].y,x2:250,y2:20+2*ro[0].y},
				
				{type:"line",block:2,   x:250,y:20,                       x2:400,y2:20},
				{type:"line",block:8,   x:250,y:20+2*ro[0].y,             x2:400,y2:20+2*ro[0].y},
				{type:"line",block:12,  x:5+3*ro[0].x+ds  ,y:20+4*ro[0].y,x2:400,y2:20+4*ro[0].y},
				{type:"line",block:15,  x:5+4*ro[0].x+2*ds,y:20+6*ro[0].y,x2:400,y2:20+6*ro[0].y},

				{type:"line",block:3,   x:400,y:20,          x2:550,y2:20},
				{type:"line",block:9,   x:400,y:20+2*ro[0].y,x2:550,y2:20+2*ro[0].y},
				{type:"line",block:13,  x:400,y:20+4*ro[0].y,x2:550,y2:20+4*ro[0].y},
				{type:"line",block:16,  x:400,y:20+6*ro[0].y,x2:550,y2:20+6*ro[0].y},

				{type:"line",block:4,   x:550,y:20,x2:795-ro[0].x,y2:20},
				{type:"line",block:10,  x:550,y:20+2*ro[0].y,x2:795-2*ro[0].x,y2:20+2*ro[0].y},
				{type:"line",block:14,  x:550,y:20+4*ro[0].y,x2:795-3*ro[0].x-ds,y2:20+4*ro[0].y},
				{type:"arc" ,block:14,  cx:795-3*ro[0].x-ds,cy:20+4*ro[0].y-radia[0],r:radia[0],start:0.5,end:0.25,CW:true},
				{type:"line",block:17,  x:550,y:20+6*ro[0].y,x2:800-3*ro[0].x-ds,y2:20+6*ro[0].y},
				{type:"line",block:18,  x:800-3*ro[0].x-ds,y:20+6*ro[0].y,x2:700,y2:20+6*ro[0].y},


				{type:"swl" ,block:5,  x:795,y:20,r:1,switch:6},
				{type:"line",block:5,  x:800,y:20,x2:795,y2:20},
				{type:"line",block:11, x:800,y:20+2*ro[0].y,x2:795-ro[0].x-ds,y2:20+2*ro[0].y},
				{type:"ds"  ,block:11, xtr:795-ro[0].x,ytr:20+ro[0].y,switchA:4,switchB:5},
			],hitboxes:[
				{eval_code:"(_x > 2.5 && _x < 52.5 && _y > 15 && _y < 40)?1:0;",name:"Switch 1",action:"tSw",switch:0},
				{eval_code:"(_x > 42.5 && _x < 97.5 && _y > 40 && _y < 80)?1:0;",name:"Switch 2&3",action:"tDS",switch:[1,2]},
				{eval_code:"(_x > 90 && _x < 150 && _y > 80 && _y < 120)?1:0;",name:"Switch 4",action:"tSw",switch:3},
				{eval_code:"(_x > 702.5 && _x < 757.5 && _y > 40 && _y < 80)?1:0;",name:"Switch 5&6",action:"tDS",switch:[4,5]},
				{eval_code:"(_x > 748.5 && _x < 797.5 && _y > 15 && _y < 40)?1:0;",name:"Switch 6",action:"tSw",switch:6},
			]},
			{Name: "Straight",OffsetX:1050,OffsetY:460,width:800,height:160,r:1,blocks:[5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5],switches:[],dotmatrix:[],data:[
				{type:"line",block:0,   x:0,y:20,          x2:200,y2:20},
				{type:"line",block:1,   x:200,y:20,        x2:400,y2:20},
				{type:"line",block:2,   x:400,y:20,        x2:600,y2:20},
				{type:"line",block:3,   x:600,y:20,        x2:800,y2:20},

				{type:"line",block:4,   x:0,y:20+2*ro[0].y,x2:5,y2:20+2*ro[0].y},
				{type:"swr" ,block:4,   x:5,y:20+2*ro[0].y,r:0,switch:0},

				{type:"line",block:5,   x:5+ro[0].x,y:20+2*ro[0].y,x2:200,y2:20+2*ro[0].y},
				{type:"line",block:6,   x:200,y:20+2*ro[0].y,x2:400,y2:20+2*ro[0].y},
				{type:"line",block:7,   x:400,y:20+2*ro[0].y,x2:600,y2:20+2*ro[0].y},
				{type:"line",block:8,   x:795-ro[0].x,y:20+2*ro[0].y,x2:600,y2:20+2*ro[0].y},

				{type:"swl" ,block:9,   x:795,y:20+2*ro[0].y,r:0,r:-1,switch:1},
				{type:"line",block:9,   x:800,y:20+2*ro[0].y,x2:795,y2:20+2*ro[0].y},
				
				{type:"arc" ,block:10, cx:5+2*ro[0].x,cy:20+4*ro[0].y-radia[0],r:radia[0],start:0.75,end:0.5,CW:true},
				{type:"line",block:10,  x:5+2*ro[0].x,y:20+4*ro[0].y,x2:200,y2:20+4*ro[0].y},
				{type:"line",block:11,  x:200,y:20+4*ro[0].y,x2:400,y2:20+4*ro[0].y},
				{type:"line",block:12,  x:400,y:20+4*ro[0].y,x2:600,y2:20+4*ro[0].y},
				{type:"line",block:13,  x:795-2*ro[0].x,y:20+4*ro[0].y,x2:600,y2:20+4*ro[0].y},
				{type:"arc" ,block:13, cx:795-2*ro[0].x,cy:20+4*ro[0].y-radia[0],r:radia[0],start:0.5,end:0.25,CW:true},
			],hitboxes:[
				{eval_code:"(_x > 2.5 && _x < 52.5 && _y > 45 && _y < 70)?1:0;",name:"Switch 1",action:"tSw",switch:0},
				{eval_code:"(_x > 748.5 && _x < 797.5 && _y > 45 && _y < 70)?1:0;",name:"Switch 2",action:"tSw",switch:1},
			]},
			{Name: "Bocht",OffsetX:1050,OffsetY:20,width:250,height:440,r:0,blocks:[5,5,5,5],switches:[],dotmatrix:[],data:[
				{type:"arc",block:0,cx:0,cy:220,r:200,start:-0.5,end:0,CW:false},
				{type:"arc",block:1,cx:0,cy:220,r:200-2*ro[0].y,start:-0.5,end:0,CW:false},
				{type:"arc",block:2,cx:0,cy:220,r:200,start:0,end:0.5,CW:false},
				{type:"arc",block:3,cx:0,cy:220,r:200-2*ro[0].y,start:0,end:0.5,CW:false}
			]},
			{Name: "Bocht",OffsetX:250,OffsetY:460,width:250,height:440,r:1,blocks:[5,5,5,5],switches:[],dotmatrix:[],data:[
				{type:"arc",block:0,cx:0,cy:220,r:200,start:-0.5,end:0,CW:false},
				{type:"arc",block:1,cx:0,cy:220,r:200-2*ro[0].y,start:-0.5,end:0,CW:false},
				{type:"arc",block:2,cx:0,cy:220,r:200,start:0,end:0.5,CW:false},
				{type:"arc",block:3,cx:0,cy:220,r:200-2*ro[0].y,start:0,end:0.5,CW:false}
			]},
		]


		var canvas = document.querySelector('canvas');
		var c = canvas.getContext('2d');

		canvas.height = window.innerHeight;
		canvas.width = window.innerWidth;

		var view = {scale:1,
			resize: function(){
				console.log("resize");
			    document.querySelector('canvas').height = window.innerHeight
				document.querySelector('canvas').width = window.innerWidth;

				view.width = window.innerWidth/view.scale;
				view.height= window.innerHeight/view.scale;
				view.ofX = 0.5*view.width/view.scale-0.5*box.width
				view.ofY = 0;

				update_frame();
			},
			rescale: function(new_scale){
				c.scale(1/view.scale,1/view.scale);
				view.scale = new_scale;
				c.scale(view.scale,view.scale);

				view.width = window.innerWidth/view.scale;
				view.height= window.innerHeight/view.scale;
				view.ofX = 0.5*view.width-0.5*box.width;
				view.ofY = 0;

				update_frame();
			}
		}

		if(window.innerWidth < 764){
			view.scale = 0.5;
		}

		// if(window.innerWidth < 764 && window.innerWidth/window.innerHeight < 1){
			//Small Portrait window
		// }

		
		var rotate_timeout;
		function rotate(){
			console.log("rotate");
			rotate_timeout = setTimeout(function(){view.resize()},1000);
		}

		
	    if("onorientationchange" in window){
	    	window.addEventListener("orientationchange", rotate, false);
	    }else{
	    	window.addEventListener("resize", view.resize, false);
	    }

		
		// window.addEventListener("resize", view.resize, false);

		// c.scale(0.8,0.8)
		c.lineWidth = 6;

		//Calculate dotmatrix
		$.each(modules,function(module,module_v){
			$.each(module_v.data,function(i,v){
				var coords = [];
				var block_list = [];
				var switch_list = [];
				if(v.type == "line"){
					coords.push({x:v.x,y:v.y});
					coords.push({x:v.x2,y:v.y2});
					block_list.push(v.block);
				}
				else if(v.type == "arc"){
					coords.push({x:v.cx+Math.cos(v.start*Math.PI)*v.r,y:v.cy+Math.sin(v.start*Math.PI)*v.r});
					coords.push({x:v.cx+Math.cos(v.end*Math.PI)*v.r,y:v.cy+Math.sin(v.end*Math.PI)*v.r});
					block_list.push(v.block);
				}
				else if(v.type == "swl"){
					coords.push({x:v.x,y:v.y});
					if(v.r == 0.25){
						coords.push({x:v.x+ro[0].x+ds,y:v.y+2*ro[0].y});
						coords.push({x:v.x+ro[0].x,y:v.y+ro[0].y});
					}else if(v.r == -0.25){
						coords.push({x:v.x+ro[0].x+ds,y:v.y-2*ro[0].y});
						coords.push({x:v.x+ro[0].y,y:v.y-ro[0].x});
					}
					else if(v.r == 0){
						coords.push({x:v.x+ro[0].x,y:v.y});
						coords.push({x:v.x+ro[0].x,y:v.y-ro[0].y});
					}
					else if(v.r == 1 || v.r == -1){
						coords.push({x:v.x-ro[0].x,y:v.y});
						coords.push({x:v.x-ro[0].x,y:v.y+ro[0].y});
					}
					block_list.push(v.block);
					switch_list.push(v.switch);
				}
				else if(v.type == "swr"){
					coords.push({x:v.x,y:v.y});
					if(v.r == 0.25){
						coords.push({x:v.x+ro[0].x+ds,y:v.y+2*ro[0].y});
						coords.push({x:v.x+ro[0].y,y:v.y+ro[0].x});
					}else if(v.r == -0.25){
						coords.push({x:v.x+ro[0].x+ds,y:v.y-2*ro[0].y});
						coords.push({x:v.x+ro[0].y,y:v.y-ro[0].x});
					}
					else if(v.r == 0){
						coords.push({x:v.x+ro[0].x,y:v.y});
						coords.push({x:v.x+ro[0].x,y:v.y+ro[0].y});
					}
					else if(v.r == -1 || v.r == 1){
						coords.push({x:v.x-ro[0].x,y:v.y});
						coords.push({x:v.x-ro[0].x,y:v.y-ro[0].y});
					}
					block_list.push(v.block);
					switch_list.push(v.switch);
				}
				else if(v.type == "ds"){
					if(v.xtl != undefined && v.ytl != undefined){
						coords.push({x:v.xtl,y:v.ytl});
						coords.push({x:v.xtl+ds,y:v.ytl+ro[0].y});
						coords.push({x:v.xtl+ro[0].x,y:v.ytl+ro[0].y});
						coords.push({x:v.xtl+ro[0].x+ds,y:v.ytl+2*ro[0].y});
					}else{
						coords.push({x:v.xtr,y:v.ytr});
						coords.push({x:v.xtr-ds,y:v.ytr+ro[0].y});
						coords.push({x:v.xtr-ro[0].x,y:v.ytr+ro[0].y});
						coords.push({x:v.xtr-ro[0].x-ds,y:v.ytr+2*ro[0].y});
					}
					block_list.push(v.block);
					switch_list.push(v.switchA);
					switch_list.push(v.switchB);
				}
				else if(v.type == "dc"){
					block_list.push(v.blockA);
					block_list.push(v.blockB);

					coords.push({x:v.xtl,y:v.ytl});
					coords.push({x:v.xtl+ro[0].x,y:v.ytl});
					coords.push({x:v.xtl+2*ro[0].x,y:v.ytl});
					coords.push({x:v.xtl+ro[0].x,y:v.ytl+ro[0].y});
					coords.push({x:v.xtl,y:v.ytl+2*ro[0].y});
					coords.push({x:v.xtl+ro[0].x,y:v.ytl+2*ro[0].y});
					coords.push({x:v.xtl+2*ro[0].x,y:v.ytl+2*ro[0].y});

					switch_list.push(v.switchA);
					switch_list.push(v.switchB);
					switch_list.push(v.switchC);
					switch_list.push(v.switchD);
				}

				$.each(coords,function(i,v){
					for(var j = 0;j<=module_v.dotmatrix.length;j++){
						if(j == module_v.dotmatrix.length){
							module_v.dotmatrix.push({x:v.x,y:v.y,blocks:block_list});
							break;
						}
						if(Math.pow(v.x - module_v.dotmatrix[j].x,2)+Math.pow(v.y - module_v.dotmatrix[j].y,2) < 4){
							module_v.dotmatrix[j].blocks = module_v.dotmatrix[j].blocks.concat(block_list);
							break;
						}
					}
				});

				if(Math.max(...block_list) > module_v.blocks.length-1){
					for(0;(Math.max(...block_list) - module_v.blocks.length) > -1;0){
						module_v.blocks.push(10);
					}
				}

				if(Math.max(...switch_list) > module_v.switches.length-1){
					for(0;(Math.max(...switch_list) - module_v.switches.length) > -1;0){
						module_v.switches.push(1);
					}
				}
			});
		});

		var box = {width:1300,height:460}

		view.width = window.innerWidth/view.scale;
		view.height= window.innerHeight/view.scale;
		view.ofX = 0.5*view.width/view.scale-0.5*box.width
		view.ofY = 0;

		var window_limits = {center_x:0.5*view.width,x_left:-20,x_right:1320,y_top:0,y_bottom:480};

		c.scale(view.scale,view.scale);

		function setStrokeColor(b, s = 0){
			if(b == 0){ // Blocked
				(s == 0)?c.strokeStyle = "#900":c.strokeStyle = "#b66";
		   	}
		   	else if(b == 1){ // Red
		    	(s == 0)?c.strokeStyle = "#f00":c.strokeStyle = "#f66";
		    }
		    else if(b == 2){ // Slow
		    	(s == 0)?c.strokeStyle = "#f70":c.strokeStyle = "#fd6";
		    }
		    else if(b == 3){ // Ghost
		    	(s == 0)?c.strokeStyle = "#f5f":c.strokeStyle = "#fbf";
		    }
		    else if(b == 4){ // Reserved
		    	(s == 0)?c.strokeStyle = "#00f":c.strokeStyle = "#66f";
		    }
		    else if(b == 5){ // Free
		    	(s == 0)?c.strokeStyle = "#777":c.strokeStyle = "#bbb";
		    }
		    else{ //Unknown
		    	(s == 0)?c.strokeStyle = "#ddd":c.strokeStyle = "#eee";
		    }
		}

		function update_frame(){
			console.log("Clear\t"+view.width+"\t",view.height);
			c.clearRect(0, 0, view.width, view.height);
			c.lineWidth = 6;
			//Draw background lines
			$.each(modules,function(module,module_v){
				var ofX = module_v.OffsetX + view.ofX;
				var ofY = module_v.OffsetY + view.ofY;
				var rvX = Math.cos(module_v.r*Math.PI);
				var rvX_ = Math.cos((module_v.r+0.5)*Math.PI);
				var rvY = Math.sin((module_v.r+0.5)*Math.PI);
				var rvY_ = Math.sin((module_v.r)*Math.PI);
				$.each(module_v.data,function(i,v){
					c.beginPath();
					c.strokeStyle = v.stroke;
					if(v.type == "swr"){ // Switch Right
						cv_Draw_SW(rvX*v.x +rvY_*v.y +ofX,rvY*v.y +rvX_*v.x +ofY,v.r-module_v.r,"swr","B",module_v.blocks[v.block],module_v.switches[v.switch]);
					}
					else if(v.type == "swl"){ // Switch Left
						cv_Draw_SW(rvX*v.x +rvY_*v.y +ofX,rvY*v.y +rvX_*v.x +ofY,v.r-module_v.r,"swl","B",module_v.blocks[v.block],module_v.switches[v.switch]);
					}else if(v.type == "ds"){ //Double slip
						if(v.xtl != undefined && v.ytl != undefined){
							setStrokeColor(module_v.blocks[v.block],1)
							if(module_v.switches[v.switchA] == 0){
								if(module_v.switches[v.switchB] == 0){
									c.moveTo(v.xtl+ofX,v.ytl+ofY);
									c.lineTo(v.xtl+ofX+ro[0].x+ds,v.ytl+ofY+2*ro[0].y);
									c.stroke();c.beginPath();
								}else{
									c.arc(v.xtl+ofX+ro[0].x,v.ytl+ofY-ro[0].yr,radia[0],Math.PI* 0.75,Math.PI* 0.50,true);
									c.stroke();c.beginPath();
								}
								c.moveTo(v.xtl+ofX+ds,v.ytl+ofY+ro[0].y);
								c.lineTo(v.xtl+ofX+ro[0].x,v.ytl+ofY+ro[0].y);
								c.stroke();c.beginPath();
								c.arc(v.xtl+ofX-8.28,v.ytl+ofY+radia[0]+ro[0].y,radia[0],Math.PI*-0.50,Math.PI*-0.25,false);
								c.stroke();c.beginPath();
							}else{
								if(module_v.switches[v.switchB] == 0){
									c.arc(v.xtl+ofX-8.28,v.ytl+ofY+radia[0]+ro[0].y,radia[0],Math.PI*-0.50,Math.PI*-0.25,false);
									c.stroke();c.beginPath();
								}
								else{
									c.moveTo(v.xtl+ofX+ds,v.ytl+ofY+ro[0].y);
									c.lineTo(v.xtl+ofX+ro[0].x,v.ytl+ofY+ro[0].y);
									c.stroke();c.beginPath();
								}
								c.arc(v.xtl+ofX+ro[0].x,v.ytl+ofY-ro[0].yr,radia[0],Math.PI* 0.75,Math.PI* 0.50,true);
								c.stroke();c.beginPath();
								c.moveTo(v.xtl+ofX,v.ytl+ofY);
								c.lineTo(v.xtl+ofX+ro[0].x+ds,v.ytl+ofY+2*ro[0].y);
								c.stroke();c.beginPath();
							}
						}
						else{
							setStrokeColor(module_v.blocks[v.block],1)
							if(module_v.switches[v.switchA] == 0){
								if(module_v.switches[v.switchB] == 0){
									c.arc(v.xtr+ofX-ro[0].x,v.ytr+ofY-ro[0].yr,radia[0],Math.PI*0.25,Math.PI*0.50,false);
									c.stroke();c.beginPath();
								}else{
									c.moveTo(v.xtr+ofX-ds,v.ytr+ofY+ro[0].y);
									c.lineTo(v.xtr+ofX-ro[0].x,v.ytr+ofY+ro[0].y);
									c.stroke();c.beginPath();
								}
								c.arc(v.xtr+ofX+8.28,v.ytr+ofY+radia[0]+ro[0].y,radia[0],Math.PI*-0.50,Math.PI*-0.75,true);
								c.stroke();c.beginPath();
								c.moveTo(v.xtr+ofX,v.ytr+ofY);
								c.lineTo(v.xtr+ofX-ro[0].x-ds,v.ytr+ofY+2*ro[0].y);
								c.stroke();c.beginPath();
							}else{
								if(module_v.switches[v.switchB] == 0){
									c.moveTo(v.xtr+ofX,v.ytr+ofY);
									c.lineTo(v.xtr+ofX-ro[0].x-ds,v.ytr+ofY+2*ro[0].y);
									c.stroke();c.beginPath();
								}else{
									c.arc(v.xtr+ofX+8.28,v.ytr+ofY+radia[0]+ro[0].y,radia[0],Math.PI*-0.50,Math.PI*-0.75,true);
									c.stroke();c.beginPath();	
								}
								c.arc(v.xtr+ofX-ro[0].x,v.ytr+ofY-ro[0].yr,radia[0],Math.PI*0.25,Math.PI*0.50,false);
								c.stroke();c.beginPath();
								c.moveTo(v.xtr+ofX-ds,v.ytr+ofY+ro[0].y);
								c.lineTo(v.xtr+ofX-ro[0].x,v.ytr+ofY+ro[0].y);
								c.stroke();c.beginPath();
							}
						}
					}
					else if(v.type == "dc"){ //Double crossover
						if(v.xtl != undefined && v.ytl != undefined){
							setStrokeColor(module_v.blocks[v.blockA],1);
							if(module_v.switches[v.switchA] == 1 || module_v.switches[v.switchB] == 1){
								c.moveTo(v.xtl+ofX,v.ytl+ofY);
								c.lineTo(v.xtl+ofX+1*ro[0].x,v.ytl+ofY);
								c.stroke();c.beginPath();
								c.moveTo(v.xtl+ofX+1*ro[0].x,v.ytl+ofY);
								c.lineTo(v.xtl+ofX+2*ro[0].x,v.ytl+ofY);
								c.stroke();c.beginPath();
							}
							if(module_v.switches[v.switchA] == 0){
								c.arc(v.xtl+ofX,v.ytl+ofY+radia[0],radia[0],Math.PI*-0.5+0.05,Math.PI*-0.25,false);
								c.stroke();c.beginPath();
							}

							if(module_v.switches[v.switchB] == 0){
								c.arc(v.xtl+ofX+2*ro[0].x,v.ytl+ofY+radia[0],radia[0],Math.PI*-0.5-0.05,Math.PI*-0.75,true);
								c.stroke();c.beginPath();
							}

							setStrokeColor(module_v.blocks[v.blockB],1);
							if(module_v.switches[v.switchC] == 1 || module_v.switches[v.switchD] == 1){
								c.moveTo(v.xtl+ofX,v.ytl+ofY+2*ro[0].y);
								c.lineTo(v.xtl+ofX+1*ro[0].x,v.ytl+ofY+2*ro[0].y);
								c.stroke();c.beginPath();
								c.moveTo(v.xtl+ofX+1*ro[0].x,v.ytl+ofY+2*ro[0].y);
								c.lineTo(v.xtl+ofX+2*ro[0].x,v.ytl+ofY+2*ro[0].y);
								c.stroke();c.beginPath();
							}
							if(module_v.switches[v.switchC] == 0){
								c.arc(v.xtl+ofX,v.ytl+ofY+2*ro[0].y-radia[0],radia[0],Math.PI*0.5-0.05,Math.PI*0.25,true);
								c.stroke();c.beginPath();
							}

							if(module_v.switches[v.switchD] == 0){
								c.arc(v.xtl+ofX+2*ro[0].x,v.ytl+ofY+2*ro[0].y-radia[0],radia[0],Math.PI*0.5+0.05,Math.PI*0.75,false);
								c.stroke();c.beginPath();
							}

						}
					}
					c.stroke();
				});
			});

			c.lineWidth = 0.1;
			//Draw dots
			var dot_radius = Math.min(2.8*view.scale,2.8);
			$.each(modules,function(module,module_v){
				var ofX = module_v.OffsetX + view.ofX;
				var ofY = module_v.OffsetY + view.ofY;
				var rvX = Math.cos(module_v.r*Math.PI);
				var rvX_ = Math.cos((module_v.r+0.5)*Math.PI);
				var rvY = Math.sin((module_v.r+0.5)*Math.PI);
				var rvY_ = Math.sin((module_v.r)*Math.PI);
				$.each(module_v.dotmatrix,function(i,v){
					c.beginPath();
					var block_state = 255;
					$.each(v.blocks,function(i2,v2){
						if(module_v.blocks[v2] < block_state){
							block_state = module_v.blocks[v2];
						}
					});
					c.arc(ofX+rvX*v.x+rvY_*v.y,ofY+rvY*v.y+rvX_*v.x,dot_radius,0,2*Math.PI,false);
					setStrokeColor(block_state,0);
					c.fillStyle = c.strokeStyle;
					c.fill();
					c.stroke();
				});
			});

			//Draw lines
			c.lineWidth = 6;
			$.each(modules,function(module,module_v){
				var ofX = module_v.OffsetX + view.ofX;
				var ofY = module_v.OffsetY + view.ofY;
				var rvX = Math.cos(module_v.r*Math.PI);
				var rvX_ = Math.cos((module_v.r+0.5)*Math.PI);
				var rvY = Math.sin((module_v.r+0.5)*Math.PI);
				var rvY_ = Math.sin((module_v.r)*Math.PI);
				$.each(module_v.data,function(i,v){
					c.beginPath();
					c.strokeStyle = v.stroke;
					if(v.type == "line"){
						setStrokeColor(module_v.blocks[v.block]);
						c.moveTo(rvX*v.x +rvY_*v.y +ofX,rvY*v.y +rvX_*v.x +ofY);
						c.lineTo(rvX*v.x2+rvY_*v.y2+ofX,rvY*v.y2+rvX_*v.x2+ofY);
					}
					else if(v.type == "arc"){
						setStrokeColor(module_v.blocks[v.block]);
						c.arc(rvX*v.cx+rvY_*v.cy+ofX,rvY*v.cy+rvX_*v.cx+ofY,v.r,Math.PI*(-module_v.r+v.start),Math.PI*(-module_v.r+v.end),v.CW);
					}
					else if(v.type == "swr"){ // Switch Right
						cv_Draw_SW(rvX*v.x +rvY_*v.y +ofX,rvY*v.y +rvX_*v.x +ofY,v.r-module_v.r,"swr","P",module_v.blocks[v.block],module_v.switches[v.switch]);
					}
					else if(v.type == "swl"){ // Switch Left
						cv_Draw_SW(rvX*v.x +rvY_*v.y +ofX,rvY*v.y +rvX_*v.x +ofY,v.r-module_v.r,"swl","P",module_v.blocks[v.block],module_v.switches[v.switch]);
					}
					else if(v.type == "ds"){ //Double slip
						if(v.xtl != undefined && v.ytl != undefined){
							setStrokeColor(module_v.blocks[v.block],0)
							if(module_v.switches[v.switchA] == 0){
								if(module_v.switches[v.switchB] == 0){
									c.arc(v.xtl+ofX+ro[0].x,v.ytl+ofY-ro[0].yr,radia[0],Math.PI* 0.75,Math.PI* 0.50,true);
									c.stroke();c.beginPath();
								}else{
									c.moveTo(v.xtl+ofX,v.ytl+ofY);
									c.lineTo(v.xtl+ofX+ro[0].x+ds,v.ytl+ofY+2*ro[0].y);
									c.stroke();c.beginPath();
								}
							}else{
								if(module_v.switches[v.switchB] == 0){
									c.moveTo(v.xtl+ofX+ds,v.ytl+ofY+ro[0].y);
									c.lineTo(v.xtl+ofX+ro[0].x,v.ytl+ofY+ro[0].y);
									c.stroke();c.beginPath();
								}
								else{
									c.arc(v.xtl+ofX-8.28,v.ytl+ofY+radia[0]+ro[0].y,radia[0],Math.PI*-0.50,Math.PI*-0.25,false);
									c.stroke();c.beginPath();
								}
							}
						}
						else{
							setStrokeColor(module_v.blocks[v.block],0)
							if(module_v.switches[v.switchA] == 0){
								if(module_v.switches[v.switchB] == 0){
									c.moveTo(v.xtr+ofX-ds,v.ytr+ofY+ro[0].y);
									c.lineTo(v.xtr+ofX-ro[0].x,v.ytr+ofY+ro[0].y);
									c.stroke();c.beginPath();
								}else{
									c.arc(v.xtr+ofX-ro[0].x,v.ytr+ofY-ro[0].yr,radia[0],Math.PI*0.25,Math.PI*0.50,false);
									c.stroke();c.beginPath();
								}
							}else{
								if(module_v.switches[v.switchB] == 0){
									c.arc(v.xtr+ofX+8.28,v.ytr+ofY+radia[0]+ro[0].y,radia[0],Math.PI*-0.50,Math.PI*-0.75,true);
									c.stroke();c.beginPath();
								}else{
									c.moveTo(v.xtr+ofX,v.ytr+ofY);
									c.lineTo(v.xtr+ofX-ro[0].x-ds,v.ytr+ofY+2*ro[0].y);
									c.stroke();c.beginPath();	
								}
							}
						}
					}
					else if(v.type == "dc"){
						if(v.xtl != undefined && v.ytl != undefined){
							setStrokeColor(module_v.blocks[v.blockA],0);
							if(module_v.switches[v.switchA] == 0 && module_v.switches[v.switchB] == 0){
								c.moveTo(v.xtl+ofX,v.ytl+ofY);
								c.lineTo(v.xtl+ofX+1*ro[0].x,v.ytl+ofY);
								c.stroke();c.beginPath();
								c.moveTo(v.xtl+ofX+1*ro[0].x,v.ytl+ofY);
								c.lineTo(v.xtl+ofX+2*ro[0].x,v.ytl+ofY);
								c.stroke();c.beginPath();
							}
							else{
								if(module_v.switches[v.switchA] == 1){
									c.arc(v.xtl+ofX,v.ytl+ofY+radia[0],radia[0],Math.PI*-0.5,Math.PI*-0.25,false);
									c.stroke();c.beginPath();
								}

								if(module_v.switches[v.switchB] == 1){
									c.arc(v.xtl+ofX+2*ro[0].x,v.ytl+ofY+radia[0],radia[0],Math.PI*-0.5,Math.PI*-0.75,true);
									c.stroke();c.beginPath();
								}
							}

							setStrokeColor(module_v.blocks[v.blockB],0);
							if(module_v.switches[v.switchC] == 0 && module_v.switches[v.switchD] == 0){
								c.moveTo(v.xtl+ofX,v.ytl+ofY+2*ro[0].y);
								c.lineTo(v.xtl+ofX+1*ro[0].x,v.ytl+ofY+2*ro[0].y);
								c.stroke();c.beginPath();
								c.moveTo(v.xtl+ofX+1*ro[0].x,v.ytl+ofY+2*ro[0].y);
								c.lineTo(v.xtl+ofX+2*ro[0].x,v.ytl+ofY+2*ro[0].y);
								c.stroke();c.beginPath();
							}
							else{
								if(module_v.switches[v.switchC] == 1){
									c.arc(v.xtl+ofX,v.ytl+ofY+2*ro[0].y-radia[0],radia[0],Math.PI*0.5,Math.PI*0.25,true);
									c.stroke();c.beginPath();
								}

								if(module_v.switches[v.switchD] == 1){
									c.arc(v.xtl+ofX+2*ro[0].x,v.ytl+ofY+2*ro[0].y-radia[0],radia[0],Math.PI*0.5,Math.PI*0.75,false);
									c.stroke();c.beginPath();
								}
							}

						}
					}
					c.stroke();
				});
			});

			//Draw Tooltips
			$.each(modules,function(module,module_v){
				var ofX = module_v.OffsetX + view.ofX;
				var ofY = module_v.OffsetY + view.ofY;
				var rvX = Math.cos(module_v.r*Math.PI);
				var rvX_ = Math.cos((module_v.r+0.5)*Math.PI);
				var rvY = Math.sin((module_v.r+0.5)*Math.PI);
				var rvY_ = Math.sin((module_v.r)*Math.PI);
				c.beginPath();
				c.moveTo(ofX,ofY);
				c.lineTo(rvX*module_v.width+ofX,rvX_*module_v.width+ofY);
				c.lineTo(rvX*module_v.width+rvY_*module_v.height+ofX,rvY*module_v.height+rvX_*module_v.width+ofY);
				c.lineTo(rvY_*module_v.height+ofX,rvY*module_v.height+ofY);
				c.lineTo(ofX,ofY);
				c.lineWidth = 0.5;
				c.strokeStyle = "#000";
				c.stroke();
				// $.each(module_v.data,function(i,v){
				// 	if(v.tooltip){
				// 		if(v.type == "dc"){
				// 			c.lineWidth = 1;
				// 			c.beginPath();
				// 			c.rect(v.xtl+ofX,v.ytl+ofY+3*ro[0].y,2*ro[0].x,(1.6+0.5+0.5+2.5)*ro[0].y);
				// 			c.strokeStyle = "#000";
				// 			c.fillStyle = "#fff";
				// 			c.fill();
				// 			c.stroke(); 

				// 			var mid = v.xtl+ofX+ro[0].x;

				// 			c.strokeStyle = "#ddd";
				// 			// c.lineWidth = 0.5;
				// 			c.beginPath();
				// 			c.moveTo(mid-ro[0].x,v.ytl+ofY+(3+1.75)*ro[0].y);
				// 			c.lineTo(mid+ro[0].x,v.ytl+ofY+(3+1.75)*ro[0].y);
				// 			c.stroke();c.beginPath();
				// 			c.moveTo(mid-ro[0].x,v.ytl+ofY+(3+3.25)*ro[0].y);
				// 			c.lineTo(mid+ro[0].x,v.ytl+ofY+(3+3.25)*ro[0].y);
				// 			c.stroke();
				// 			var y_top = v.ytl+ofY+3.5*ro[0].y;
				// 			//Write all options
				// 			//A
				// 			c.strokeStyle = "#ddd";
				// 			c.lineWidth = 0.5*6;
				// 			c.beginPath();
				// 			c.arc(mid-0.5*ro[0].x,y_top+0.5*radia[0],0.5*radia[0],Math.PI*-0.5,Math.PI*-0.25,false);
				// 			c.stroke();c.beginPath();
				// 			c.arc(mid+0.5*ro[0].x,y_top+0.5*radia[0],0.5*radia[0],Math.PI*-0.5,Math.PI*-0.75,true);
				// 			c.stroke();c.beginPath();
				// 			c.arc(mid-0.5*ro[0].x,y_top+ro[0].y-0.5*radia[0],0.5*radia[0],Math.PI*0.5,Math.PI*0.25,true);
				// 			c.stroke();c.beginPath();
				// 			c.arc(mid+0.5*ro[0].x,y_top+ro[0].y-0.5*radia[0],0.5*radia[0],Math.PI*0.5,Math.PI*0.75,false);
				// 			c.stroke();c.beginPath();
				// 			c.strokeStyle = "#aaa";
				// 			c.moveTo(mid-0.5*ro[0].x,y_top);
				// 			c.lineTo(mid+0.5*ro[0].x,y_top);
				// 			c.stroke();
				// 			c.beginPath();
				// 			c.moveTo(mid-0.5*ro[0].x,y_top+ro[0].y);
				// 			c.lineTo(mid+0.5*ro[0].x,y_top+ro[0].y);
				// 			c.stroke();
				// 			//B
				// 			y_top += 1.5*ro[0].y;

				// 			c.strokeStyle = "#ddd";
				// 			c.lineWidth = 0.5*6;
				// 			c.beginPath();
				// 			c.arc(mid+0.5*ro[0].x,y_top+0.5*radia[0],0.5*radia[0],Math.PI*-0.5,Math.PI*-0.75,true);
				// 			c.stroke();c.beginPath();
				// 			c.arc(mid-0.5*ro[0].x,y_top+ro[0].y-0.5*radia[0],0.5*radia[0],Math.PI*0.5,Math.PI*0.25,true);
				// 			c.stroke();c.beginPath();
				// 			c.moveTo(mid-0.5*ro[0].x,y_top);
				// 			c.lineTo(mid+0.5*ro[0].x,y_top);
				// 			c.stroke();
				// 			c.beginPath();
				// 			c.moveTo(mid-0.5*ro[0].x,y_top+ro[0].y);
				// 			c.lineTo(mid+0.5*ro[0].x,y_top+ro[0].y);
				// 			c.stroke();c.beginPath();
				// 			c.strokeStyle = "#aaa";
				// 			c.arc(mid+0.5*ro[0].x,y_top+ro[0].y-0.5*radia[0],0.5*radia[0],Math.PI*0.5,Math.PI*0.75,false);
				// 			c.stroke();c.beginPath();
				// 			c.arc(mid-0.5*ro[0].x,y_top+0.5*radia[0],0.5*radia[0],Math.PI*-0.5,Math.PI*-0.25,false);
				// 			c.stroke();c.beginPath();
				// 			//C
				// 			y_top += 1.5*ro[0].y;

				// 			c.strokeStyle = "#ddd";
				// 			c.lineWidth = 0.5*6;
				// 			c.beginPath();
				// 			c.arc(mid+0.5*ro[0].x,y_top+ro[0].y-0.5*radia[0],0.5*radia[0],Math.PI*0.5,Math.PI*0.75,false);
				// 			c.stroke();c.beginPath();
				// 			c.arc(mid-0.5*ro[0].x,y_top+0.5*radia[0],0.5*radia[0],Math.PI*-0.5,Math.PI*-0.25,false);
				// 			c.stroke();c.beginPath();
				// 			c.moveTo(mid-0.5*ro[0].x,y_top);
				// 			c.lineTo(mid+0.5*ro[0].x,y_top);
				// 			c.stroke();
				// 			c.beginPath();
				// 			c.moveTo(mid-0.5*ro[0].x,y_top+ro[0].y);
				// 			c.lineTo(mid+0.5*ro[0].x,y_top+ro[0].y);
				// 			c.stroke();c.beginPath();
				// 			c.strokeStyle = "#aaa";
				// 			c.arc(mid+0.5*ro[0].x,y_top+0.5*radia[0],0.5*radia[0],Math.PI*-0.5,Math.PI*-0.75,true);
				// 			c.stroke();c.beginPath();
				// 			c.arc(mid-0.5*ro[0].x,y_top+ro[0].y-0.5*radia[0],0.5*radia[0],Math.PI*0.5,Math.PI*0.25,true);
				// 			c.stroke();c.beginPath();
				// 		}
				// 	}
				// });
			});
		}

		update_frame();

		var LongclickTimer;
		var Longclick = false;

		$('canvas').on('mousedown',function(evt){
			Longclick = false;
			LongclickTimer = setTimeout(function(){longClick(evt)},400);
		});

		function longClick(evt){
			alert("Long Click");
			Longclick = true;
		}

		$('canvas').on('mouseup',function(evt){
			clearTimeout(LongclickTimer);
			if(!touchClicked && !Longclick)
				canvas_hit(evt.offsetX,evt.offsetY);
			else
				touchClicked = false;
		});

		function cv_Draw_SW(x,y,r,lr,type,bl,sw){
			if(r >=  2){r -= 2;}
			if(r <= -2){r += 2;}
			var rvX = Math.cos(r*Math.PI);
			var rvX_ = Math.cos((r+0.5)*Math.PI);
			var rvY = Math.sin((r+0.5)*Math.PI);
			var rvY_ = Math.sin((r)*Math.PI);
			if((sw == 0 && type == "P") || (sw == 1 && type == "B")){
				(type == "P")?setStrokeColor(bl,0):setStrokeColor(bl,1);
				if(r == 0.25 || r == 0.75 || r == 1.25 || r == 1.75 || r == -0.25 || r == -0.75 || r == -1.25 || r == -1.75){
					c.moveTo(x,y);
					if(r == -0.25 || r == 1.75){
						c.lineTo(x+ro[0].x+ds,y-2*ro[0].y);
					}else if(r == -0.75 || r == 1.25){
						c.lineTo(x-ro[0].x-ds,y-2*ro[0].y);
					}else if(r == -1.25 || r == 0.75){
						c.lineTo(x-ro[0].x-ds,y+2*ro[0].y);
					}else if(r == -1.75 || r == 0.25){
						c.lineTo(x+ro[0].x+ds,y+2*ro[0].y);
					}
				}else if(r == 0 || r == 0.5 || r == 1 || r == 1.5 || r == 2 || r == -0.5 || r == -1 || r == -1.5 || r == -2){
					c.moveTo(x,y);
					c.lineTo(x+rvX*ro[0].x,y+rvY_*ro[0].x);
				}
			}
			else{
				(type == "P")?setStrokeColor(bl,0):setStrokeColor(bl,1);
				if(lr == "swr"){
					if(r == 0.25 || r == -1.75){
						c.arc(x-rvX*radia[0],y+rvY*radia[0],radia[0],Math.PI*(r-0.25),Math.PI*(r-0.5),true);
					}else if(r == -0.25 || r == 1.75){
						c.arc(x+rvX*radia[0],y+rvY*radia[0],radia[0],Math.PI*(r-0.25),Math.PI*(r-0.5),true);
					}else if(r == 0.75 || r == -1.25){
						c.arc(x+rvX*radia[0],y+rvY*radia[0],radia[0],Math.PI*(r-0.25),Math.PI*(r-0.5),true);
					}else if(r == -0.75 || r == 1.25){
						c.arc(x-rvX*radia[0],y+rvY*radia[0],radia[0],Math.PI*(r-0.25),Math.PI*(r-0.5),true);
					}else if(r == 0){
						c.arc(x,y+radia[0],radia[0],Math.PI*(r-0.25),Math.PI*(r-0.5),true);
					}else{
						c.arc(x,y-radia[0],radia[0],Math.PI*(r-0.25),Math.PI*(r-0.5),true);
					}
				}
				else{
					if(r == 0.25 || r == -1.75){
						c.arc(x+rvX*radia[0],y-rvY*radia[0],radia[0],Math.PI*(r+0.5),Math.PI*(r+0.25),true);//
					}else if(r == -0.25 || r == 1.75){
						c.arc(x-rvX*radia[0],y-rvY*radia[0],radia[0],Math.PI*(r+0.5),Math.PI*(r+0.25),true);//
					}else if(r == 0.75 || r == -1.25){
						c.arc(x-rvX*radia[0],y-rvY*radia[0],radia[0],Math.PI*(r+0.5),Math.PI*(r+0.25),true);//
					}else if(r == -0.75 || r == 1.25){
						c.arc(x+rvX*radia[0],y-rvY*radia[0],radia[0],Math.PI*(r+0.5),Math.PI*(r+0.25),true);
					}else if(r == 0){
						c.arc(x,y-radia[0],radia[0],Math.PI*(r+0.5),Math.PI*(r+0.25),true);
					}else if(r == -1 || r == 1){
						c.arc(x,y+radia[0],radia[0],Math.PI*(r+0.5),Math.PI*(r+0.25),true);
					}
				}
			}
		}

		$('canvas').on("mousewheel",function(evt){
			console.log("Scroll");

			if(view.width < box.width){
				view.ofX -= evt.originalEvent.deltaX/10;
				//Scroll limiter
				if(window_limits.x_left > -view.ofX){
					view.ofX = -window_limits.x_left;
				}
				if(window_limits.x_right < -view.ofX+view.width){
					view.ofX = -(window_limits.x_right - view.width);
				}
			}
			if(view.height < box.height){
				view.ofY -= evt.originalEvent.deltaY/10;
				//Scroll limiter
				if(window_limits.y_top > -view.ofY){
					view.ofY = window_limits.y_top;
				}
				if(window_limits.y_bottom < -view.ofY+view.height){
					view.ofY = -(window_limits.y_bottom - view.height);
				}
			}

			update_frame();
		})

		var touchStart = {x:0,y:0};
		var touchMove = {x:0,y:0};
		var touchMoved = false;
		var touchClicked = false;

		$('canvas').on("touchstart",function(evt){
			touchStart.x = (touchMove.x = evt.touches[0].pageX);
			touchStart.y = (touchMove.y = evt.touches[0].pageY);
			touchMoved = false;

			LongclickTimer = setTimeout(function(){longClick(evt)},600);
		});

		$('canvas').on("touchmove",function(evt){
			if(touchMoved == true){
				if(view.width < box.width){
					view.ofX += (evt.touches[0].pageX - touchMove.x)/view.scale;
					//Scroll limiter
					if((window_limits.x_left) > -view.ofX){
						view.ofX = -window_limits.x_left;
					}
					if((window_limits.x_right) < -view.ofX+view.width){
						view.ofX = -(window_limits.x_right - view.width);
					}
					console.log(view.ofX+"\t"+(window_limits.x_left)+">"+(-view.ofX)+"\t"+(window_limits.x_right)+"<"+(-view.ofX+view.width));
				}
				if(view.height < box.height){
					view.ofY += (evt.touches[0].pageY - touchMove.y)/view.scale;
					//Scroll limiter
					if((window_limits.y_top) > -view.ofY){
						view.ofY = window_limits.y_top;
					}
					if((window_limits.y_bottom) < -view.ofY-view.height){
						view.ofY = -(window_limits.y_bottom - view.height);
					}
				}

				touchMove.x = evt.touches[0].pageX;
				touchMove.y = evt.touches[0].pageY;

				update_frame();

				return false;
			}else{
				if(Math.sqrt(Math.pow(touchStart.x - evt.touches[0].pageX,2)+Math.pow(touchStart.y - evt.touches[0].pageY,2)) >= 10){
					touchMoved = true;
					clearTimeout(LongclickTimer);
					console.log("Touch Moved");
				}
			}
		});

		$('canvas').on("touchend",function(evt){
			if(touchMoved == false){
				touchClicked = true;
				canvas_hit(touchStart.x,touchStart.y);
				clearTimeout(LongclickTimer);
			}
		});

		function canvas_hit(x,y){
			var update = false;
			$.each(modules,function(module,module_v){
				var ofX = module_v.OffsetX;
				var ofY = module_v.OffsetY;
				var rvX = Math.cos(module_v.r*Math.PI);
				var rvX_ = Math.cos((module_v.r+0.5)*Math.PI);
				var rvY = Math.sin((module_v.r+0.5)*Math.PI);
				var rvY_ = Math.sin((module_v.r)*Math.PI);
				_x = x/view.scale - ofX - view.ofX;
				_y = y/view.scale - ofY - view.ofY;
				_l = Math.sqrt(Math.pow(_x,2)+Math.pow(_y,2));
				_r = Math.atan(_y/_x);
				(_x<0&&_y<0)?_r=-(Math.PI-_r):1;
				_r -= module_v.r*Math.PI;
				_x = _l*Math.cos(_r);
				_y = _l*Math.sin(_r);
				console.log(_x,_y);
				$.each(module_v.hitboxes,function(i,box){
					if(eval(box.eval_code) == 1){
						if(box.action == "tSw"){ // Throw switch
							throw_Switch(module,box.switch);
						}
						else if(box.action == "tDS"){
							throw_doubleSlib(module,box.switch);
						}
						else if(box.action == "tDC"){
							throw_doubleCrossover(module,box.switch);
						}
						else{
							alert("Hit " + box.name + "\n with no action");
						}
						update = true
					}
				});
			});
			if(update)
				update_frame();
		}

		function throw_Switch(m,s){
			if(modules[m].switches[s] == 0){
				modules[m].switches[s] = 1;
			}else{
				modules[m].switches[s] = 0;
			}
		}

		function throw_doubleSlib(m,sw){
			if(modules[m].switches[sw[0]] == 0){
				if(modules[m].switches[sw[1]] == 0){
					modules[m].switches[sw[1]] = 1;
				}else{
					modules[m].switches[sw[0]] = 1;
				}
			}else{
				if(modules[m].switches[sw[1]] == 1){
					modules[m].switches[sw[1]] = 0;
				}else{
					modules[m].switches[sw[0]] = 0;
				}
			}
		}

		function throw_doubleCrossover(m,sw){
			if(modules[m].switches[sw[0]] == 0 && modules[m].switches[sw[1]] == 0 && modules[m].switches[sw[2]] == 0 && modules[m].switches[sw[3]] == 0){
				modules[m].switches[sw[0]] = 1;
				modules[m].switches[sw[3]] = 1;
			}
			else if(modules[m].switches[sw[0]] == 1 && modules[m].switches[sw[1]] == 0 && modules[m].switches[sw[2]] == 0 && modules[m].switches[sw[3]] == 1){
				modules[m].switches[sw[0]] = 0;
				modules[m].switches[sw[3]] = 0;
				modules[m].switches[sw[1]] = 1;
				modules[m].switches[sw[2]] = 1;
			}
			else{
				modules[m].switches[sw[0]] = 0;
				modules[m].switches[sw[1]] = 0;
				modules[m].switches[sw[2]] = 0;
				modules[m].switches[sw[3]] = 0;
			}
		}
		// c.strokeStyle = "#aaaaaa";
		// c.lineWidth = 6;

		// c.beginPath();
		// c.moveTo(50,100);
		// c.lineTo(150,100);
		// c.stroke();
		// c.strokeStyle = "#dddddd";

		// c.beginPath();
		// c.arc(50,150,50,-0.5*Math.PI,-0.25*Math.PI,false);
		// c.stroke();

		// c.beginPath();
		// c.arc(50 - 2*50*Math.cos(-0.75*Math.PI),150 + 2*50*Math.sin(-0.75*Math.PI),50,0.75*Math.PI,0.5*Math.PI,true);
		// c.stroke();
	</script>
</body>
</html>
